##################################################
## Gateway Service
##################################################

apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: default
spec:
  ports:
    - name: http
      port: 5000
      targetPort: gateway-port
    - name: https
      port: 443
      targetPort: webhook-port
    # - name: admin
    #   port: 8080
    #   targetPort: admin-port
  selector:
    app: gateway
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-env-configmap
  namespace: default
data:
  APP_ENV: "production"
  ADDRESS: ":5000"

  WEBHOOK_ADDRESS: ":8443"
  WEBHOOK_KEY_DIR: "/run/secrets/tls/tls.key"
  WEBHOOK_CERT_DIR: "/run/secrets/tls/tls.crt"

  ACCOUNTS_ADDRESS: "api-accounts-v1-accountsservice.default.svc.cluster.local:5000"
  ACCOUNTS_TIMEOUT: "10"

  DISABLE_K8S_CLIENT: "false"
  ENABLE_STACKDRIVER: "false"

  PROTO_MAP: "proto/map.json"

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - name: gateway
          image: registry.gitlab.com/canderlabs/gateway-go
          imagePullPolicy: Always
          ports:
            - name: gateway-port
              containerPort: 5000
            - name: webhook-port
              containerPort: 8443
            # - name: admin-port
            #   containerPort: 8080

          envFrom:
            - configMapRef:
                name: gateway-env-configmap

          volumeMounts:
            - name: webhook-tls-certs
              mountPath: /run/secrets/tls
              readOnly: true

          livenessProbe:
            httpGet:
              path: /hz
              port: 5000
            initialDelaySeconds: 60
            periodSeconds: 120

      volumes:
        - name: webhook-tls-certs
          secret:
            secretName: webhook-server-tls

      imagePullSecrets:
        - name: gitlab-auth

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: default
---
# Role
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: default
  name: api-gateway
rules:
  - apiGroups: ['', 'extensions', 'apps']
    resources: ['services', 'namespaces']
    verbs: ['get', 'list']

---
# Role Binding
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: default
  name: api-gateway-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-gateway
subjects:
  - kind: ServiceAccount
    name: api-gateway
    namespace: default

---
##################################################
## Gateway Webhook
##################################################

apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: gateway-webhook
  namespace: default
webhooks:
  - name: gateway-service.default.svc
    clientConfig:
      service:
        name: gateway-service
        namespace: default
        path: '/admission'
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRQzh4QVNpajRUSElqQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRGN4TVRRNFdoY05NekF3TkRBeU1EY3hNVFE0V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRRGlEVEFYNFhOSmlVQkJxSDYreTBCdkFnVlZBYzRHa0tVdmlpak1wRU1DMlRNV2pSN2YKaEhpUHRWd2tXY00xbkJ5ZTRFRm9BVGIrUHo1NEhwNU5PY283NHdCYUY3ZkxzSlR1elFEbWJCeTZWcTJoanV0dAp6dkYwK3JMTmc4ZVVNb2QrR3VaTWVIUzRNaVk4VnFCdVovSGlCRHNqd1ZiSXcvS2lFd1pBT3FjcjZ6RGNEV0pUCnhpMGtIWXlHVllTSUU2YzU1eVAycVFxeDI2WVZIYXZLZGxLWG5pRVJHRFR6dndmc1Y0T1NUakxFNHdoNnFkdEUKdGU5VER5eGF0dTI0WlUrbUV2VE5hc3FzQjVxNzlmbk9wbUZ5aElUZkVINVg5eUpCR2JxN3ZueTlFaDQvY3I2dApyTFVTTE9HRW1tOXJUSldNbVRlb21BNUszMHVDWFF0RjlDNFhBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBRnMvNnRqam0wcHVFYTJhMzlDOE5nR21NQm0ydUl1REtmdnd6WVl1bmdib0dZVTFQdTBWSmRiSHFzSmMKRlRMQWs0ZWlVU0NOR2tjWkJsVHgzMEpXS0dnTHdvM1ZWRldXUWZveXFzRUkwdGlGQlBRN0hUNlprbVVJVExhTgpVVGZZZyt0REhLSzY3SXpjcEIxOGUwSkNDNThrZVIrSlFOQXFKLzdyd3pndXZoL205cDR0YU1NUXFyS0p5WDNxCjZYSmk4cDh3amJZaEFMWEt4SEF5ZFB0L3FmeENEY2YvME9yb0ZURzNDcHRWUC92amdoVlhEb1RtbWlCK0dENDUKK28wcWxaZFQxMllEdDVVWCsreW42ZDE1WStsTnU0bytMSm5QMlR4cnl6NjhLajhJeFAxYXJLTzVLV0tZcERyTgpoT2wwdmpzK2Z2NmpSZEZLV29CSWNjMlRyNlk9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ['*']
        apiGroups: ['*']
        apiVersions: ['*']
        resources: ['services']

---
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRQzh4QVNpajRUSElqQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRGN4TVRRNFdoY05NekF3TkRBeU1EY3hNVFE0V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRRGlEVEFYNFhOSmlVQkJxSDYreTBCdkFnVlZBYzRHa0tVdmlpak1wRU1DMlRNV2pSN2YKaEhpUHRWd2tXY00xbkJ5ZTRFRm9BVGIrUHo1NEhwNU5PY283NHdCYUY3ZkxzSlR1elFEbWJCeTZWcTJoanV0dAp6dkYwK3JMTmc4ZVVNb2QrR3VaTWVIUzRNaVk4VnFCdVovSGlCRHNqd1ZiSXcvS2lFd1pBT3FjcjZ6RGNEV0pUCnhpMGtIWXlHVllTSUU2YzU1eVAycVFxeDI2WVZIYXZLZGxLWG5pRVJHRFR6dndmc1Y0T1NUakxFNHdoNnFkdEUKdGU5VER5eGF0dTI0WlUrbUV2VE5hc3FzQjVxNzlmbk9wbUZ5aElUZkVINVg5eUpCR2JxN3ZueTlFaDQvY3I2dApyTFVTTE9HRW1tOXJUSldNbVRlb21BNUszMHVDWFF0RjlDNFhBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBRnMvNnRqam0wcHVFYTJhMzlDOE5nR21NQm0ydUl1REtmdnd6WVl1bmdib0dZVTFQdTBWSmRiSHFzSmMKRlRMQWs0ZWlVU0NOR2tjWkJsVHgzMEpXS0dnTHdvM1ZWRldXUWZveXFzRUkwdGlGQlBRN0hUNlprbVVJVExhTgpVVGZZZyt0REhLSzY3SXpjcEIxOGUwSkNDNThrZVIrSlFOQXFKLzdyd3pndXZoL205cDR0YU1NUXFyS0p5WDNxCjZYSmk4cDh3amJZaEFMWEt4SEF5ZFB0L3FmeENEY2YvME9yb0ZURzNDcHRWUC92amdoVlhEb1RtbWlCK0dENDUKK28wcWxaZFQxMllEdDVVWCsreW42ZDE1WStsTnU0bytMSm5QMlR4cnl6NjhLajhJeFAxYXJLTzVLV0tZcERyTgpoT2wwdmpzK2Z2NmpSZEZLV29CSWNjMlRyNlk9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRRDlkR3NYbHYzb0VqQU5CZ2txaGtpRzl3MEJBUVVGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRGN4TVRRNFdoY05NakF3TlRBME1EY3hNVFE0V2pBbQpNU1F3SWdZRFZRUUREQnRuWVhSbGQyRjVMWE5sY25acFkyVXVaR1ZtWVhWc2RDNXpkbU13Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUURWY09BN1owM3hhb2sxZVpQamNva0VzdE54SHd3cGE1M1YKRjBaRHpaY2xEcEdOaVZOSDVyNTNCdys5RmFFSVYrUnBZOFdxck1UcjQwdEJMb2ZTSGNmbHVqWDlibGRMaDBKYQpXbDJEK1dkTTlhSTllQlE0QkNIbjdPSDM5ZGthMGc3MVdQZ0J4Nyt4TS83Y0JRYnNwdWJkRmpxZmovamZQWFMxCmpaNThFdUlpKzdXSlRuSlpGTzRIREdvNGcveHN0WXNHWkxzM0JvL1lWbW5JZStTbHlrMDI5c0prU0U3M2xIVEMKeTNIYjdSTTMxODlGcTNWOW9Fcm1HSmtpSzF6MUhnVEZBMlQrYUViV3ZycHI1cWxEMW94T0EwakdrYUs1Qm1aRgpFbHJyNDhDN3c4NlFoc3lySXV4NlBQelpkV2FzUDJicllvcHduQThsMUdnYU43emxzNnhiQWdNQkFBRXdEUVlKCktvWklodmNOQVFFRkJRQURnZ0VCQUdLUUhFVkNuUjNMQWt3MU82M2pUd1lTMHZqNkFWUjhKQmN3SnRRNVg3OWMKRlZkcTZSMVlablZiWFdXMHN3N2kyN1QycjREVmhWeERjQzBYRGVwOVlMbFVoSitlOTZpTytqc0ZxVENhYytZYgpwS3VBUG5PQmhUTU9VdVBTOEdJeE51NnB6bHZ1NkdmRlA1aFgwMjNWMmVIZlhyWkRwbHZwZ2lOTEY4YUx6M3FECjlhUWF5UWRUTTRDcVZRdWkyYzkzYU5LeklCM3c1MThnOW9vUjVtZ0xXQWxBb1VxNk5SaU1DWUNLeUE3cWJiMW0KZWp0eUJiOUU4Y3VMQWRNd1JmLzJvZDBnc3pDWlJlc2orK0d0Y1lUZmcwbWJCZEVGdVh2aDdJOXM4R0ticE1HUApmeXFSZnE3UXBzYk1VdlJ6ZHVUd3dyd1ZXaGxhR25SbVB2UndPZTIxZEZRPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBMVhEZ08yZE44V3FKTlhtVDQzS0pCTExUY1I4TUtXdWQxUmRHUTgyWEpRNlJqWWxUClIrYStkd2NQdlJXaENGZmthV1BGcXF6RTYrTkxRUzZIMGgzSDVibzEvVzVYUzRkQ1dscGRnL2xuVFBXaVBYZ1UKT0FRaDUremg5L1haR3RJTzlWajRBY2Uvc1RQKzNBVUc3S2JtM1JZNm40LzQzejEwdFkyZWZCTGlJdnUxaVU1eQpXUlR1Qnd4cU9JUDhiTFdMQm1TN053YVAyRlpweUh2a3BjcE5OdmJDWkVoTzk1UjB3c3R4MiswVE45ZlBSYXQxCmZhQks1aGlaSWl0YzlSNEV4UU5rL21oRzFyNjZhK2FwUTlhTVRnTkl4cEdpdVFabVJSSmE2K1BBdThQT2tJYk0KcXlMc2VqejgyWFZtckQ5bTYyS0tjSndQSmRSb0dqZTg1Yk9zV3dJREFRQUJBb0lCQUJkZ2w0NnFEK1ZqTDhnRgptdWNNZ21sYlZNRk5EejN5SllWVFdVVFAzY0FYU21YZ0pwajNjdUVDaXZ6QXc3UndPL28zRFUxV1F2TTdIK0R4CndicUh2SDh5MS9yNy9OK3UzdHVhamllSVI0SXNYU3F5WGpTTWIxSkJwYlpNM1F5TStVcHlCaWZid3VrYnNzeFMKV0tITzNmWlZHdktqQ0RVYlBBOHVoYTg5T2p0dWR2RDRod04venNEbnRYeFJUOEVUZkEyK2ltWEJQMWM0Z2w4VApWVUQrOWV3d0FPVzVBV09iekQraTVTbmJnL1Z3MmoyanVkRTBqZXgyT1pFRHpiOG9mSkwvem1FYVNOWjVxY0RvCkVkbzRzVmtPSGJMckloMGhvbmlDVjIzSm01ZHNsTjJ4MVdaSEUxQ2phZ2FieHJrRmxUNTNHK0pPQ0JGRFNJeDIKUXUrQ1hVRUNnWUVBK1ppaDZVYlF3QUo1UzdKS1hnb1Y2cWUxYlBSRzJlakdrZ1Rzd3lUNzBsNlRMUGJNMktnMgp3MGVrQnZzZ3RPdUs1SEsvQzBHbWlkZGtSRTYxamhhWXkyM2Nkb2QzaXREa3ErcG9CUXh0QWRJekMzSklHMmY5Cm5xeWRsWVhIc3A2UStpVW9tMUM1OTEyd2dCcjBSWThHZEQ2UjhmWG5YdDN3ZFNMS2Z0aDJlTkVDZ1lFQTJ1ckYKeVZaL3V3S1BuRFNHWGI5T29LN0VJUFRNZ3NheUdHY2dqeC9LbUdmbjNFUm1jNlloa1djMlhqbmROV1J6dTAwYwpncGg1NUdhQlZIOFpzZkpYY0xYS3kraXZ3WHowRldlSmh4cVRiUzBvRnc5YWloYkVkZXNyTzZob25RVk1FZVVzClMzU2tZNXhGNjAyclBNTG9zWHFENTRobmJRcnRYd29EeEtobm5Xc0NnWUI2ZnZKWHJxMmN6cG9CRUl0M0E3UWwKNmhFY1cvYTUwNGhBK2JISlJFbGl3WSt4clo1elpuc1o4L3NJZ2c5WE81SjY4K1hXL0cxamtSWmdmOUNTMzN3MQp1c0ZNV3NmTWxTRGxUckdtYUtiSEVnYURRNThuOUMyQXhtN0FoMXV1eWl1VTJNL0pDaUY2eWJ4cDR0Q25vcjRrCkp1RXh3dUcrcVdYdDF4bFNqNkgxUVFLQmdRQ1J6YVhYdUEyd2Z6OG8yVzdZaDI4VjQvQnF4c0JqSlhVK2ZZa1kKNmlLa0tTZ3E4eitOTFF2VWJQcXYvVGdRdEl2RUp0S2pSR3lDcTZiZG9SMTdBQjR1eWxWOFE4aXpSTWJJYnNJUgpRcWtJSVBnL2k1RlF3V010Nm1oTC9wbFdZMDNMNldmOEJYN3JmUXl3Y0hWcExhT1BlVHJhL1dWdEljY0E4b21aCjlGTzJhd0tCZ0VzWW8wT0tPWHhvN3NjbllGV1ExYTI3bzN2eHZHSVlGYlBCYStCSGxNc3gyakorTHk4ZnJMcTYKWTVnYnBHUVc1T1VUQm1qNk5haTFMQTgrVG12RnBCQkxsc0F6d2F0ZkhqL1FhMXNmbDNaLzRzOGlBR3ZHc0V4Ygp3YnFQZHV2b0R0MHk1WmNKdWlkTmxSVWpDMHpaelptU1h4VktnaFZYTTN1RVIwV29FTkpzCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: default
type: Opaque
