##################################################
## Gateway Service
##################################################

apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: default
spec:
  ports:
    - name: http
      port: 5000
      targetPort: gateway-port
    - name: https
      port: 443
      targetPort: webhook-port
    # - name: admin
    #   port: 8080
    #   targetPort: admin-port
  selector:
    app: gateway
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-env-configmap
  namespace: default
data:
  APP_ENV: "production"
  ADDRESS: ":5000"

  WEBHOOK_ADDRESS: ":8443"
  WEBHOOK_KEY_DIR: "/run/secrets/tls/tls.key"
  WEBHOOK_CERT_DIR: "/run/secrets/tls/tls.crt"

  ACCOUNTS_ADDRESS: "api-accounts-v1-accountsservice.default.svc.cluster.local:5000"
  ACCOUNTS_TIMEOUT: "10"

  DISABLE_K8S_CLIENT: "false"
  ENABLE_STACKDRIVER: "false"

  PROTO_MAP: "proto/map.json"

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - name: gateway
          image: registry.gitlab.com/isaiahwong/cluster/gateway
          imagePullPolicy: Always
          ports:
            - name: gateway-port
              containerPort: 5000
            - name: webhook-port
              containerPort: 8443
            # - name: admin-port
            #   containerPort: 8080

          envFrom:
            - configMapRef:
                name: gateway-env-configmap

          volumeMounts:
            - name: webhook-tls-certs
              mountPath: /run/secrets/tls
              readOnly: true

          livenessProbe:
            httpGet:
              path: /hz
              port: 5000
            initialDelaySeconds: 60
            periodSeconds: 120

      volumes:
        - name: webhook-tls-certs
          secret:
            secretName: webhook-server-tls

      imagePullSecrets:
        - name: gitlab-auth

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: default
---
# Role
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: default
  name: api-gateway
rules:
  - apiGroups: ['', 'extensions', 'apps']
    resources: ['services', 'namespaces']
    verbs: ['get', 'list']

---
# Role Binding
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: default
  name: api-gateway-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-gateway
subjects:
  - kind: ServiceAccount
    name: api-gateway
    namespace: default

---
##################################################
## Gateway Webhook
##################################################

apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: gateway-webhook
  namespace: default
webhooks:
  - name: gateway-service.default.svc
    clientConfig:
      service:
        name: gateway-service
        namespace: default
        path: '/admission'
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRRHErMGM4blJtaHB6QU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFEwTVRNNFdoY05NekF3TkRBeU1EUTBNVE00V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRREVjbFRldEs0TFcrL1Q4Z1FCWHQ4SGxmc2J3NUkwNHZkVS9zdHI3RjNrN2w5Y1hsemMKeC9YQUR3QzBQSDhuTklZVy9DQ1dvNlk4eDRQSWRoTG9SVGFwN1dqRFRkUkx0bVQra1VxOXlUQy82Qm1sdFB4VwpwQ2tiWDBRWkdjYndheXp0QlV1QW5IR2ZXS1IvSFFSUDZOTU5tKy95V2YrZFM2NVNNNTk4bVIveUJ2UUh5K2J2ClZGTFlsa1I2SC9jaUtNUllrNzBPL0ZkTW93dmVjcWc1TlpPTjZQM0o5N3kzaGZJRUY1dWR5ZmY1RmI4cGxoOE8KeTJiRkFoWnFoc0VMdGRTVDlCckoxTitCQ1VJT0xIM3dQVkhaRFpnWFl5Q2REdEFZSVlxMDY3aVBGRHE0c3o1KwpiSTBoejVwMTdZWkhGVnpRT3dNeXZVVnd4WmhBa0Y2NTVkaWRBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBRHhFRkE3R0I5OWJKVWVVSi83Skp3TndYQWtpdmI3SEdFajRXYkUxMUNRSGtIM1BSdFJBQ0hVcEk1UHIKRnpwbFVSQVVVOXlEN1VpYTJaMHdvVnE4OGdDdWE0WkJiTnpXS1RJV0wwQ3RhcERBb3E1VmFySlYzR1FTUTBLQwpTRXg1Y3R4U0NXMG02TlYxM0dxR1pCQVJQb3VrYU1EVjMvc2Jpa0pXOXM4VnE3djBwQW8yZFRQdUN4T3hZdURYCkNaU2s0OTgzYkJZN1FjcEpxazZjZ0xHeDh2L08xV3BxYS9tY244UHlPd0lwTXBHeTN1ZTlpS3VYbzYrd0tzalQKcE9WNXRRSmREN1YxN2R5VWZiU1NZQkVXZnBLbVNEbXIyR01INmRLZm52bm4zK1JIdy9hdmpYZ0ViZ3ErSkNVRwpicGo2aWRQeGtSTFgrV2s2UHB3K29IQ201d1E9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ['*']
        apiGroups: ['*']
        apiVersions: ['*']
        resources: ['services']

---
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRRHErMGM4blJtaHB6QU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFEwTVRNNFdoY05NekF3TkRBeU1EUTBNVE00V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRREVjbFRldEs0TFcrL1Q4Z1FCWHQ4SGxmc2J3NUkwNHZkVS9zdHI3RjNrN2w5Y1hsemMKeC9YQUR3QzBQSDhuTklZVy9DQ1dvNlk4eDRQSWRoTG9SVGFwN1dqRFRkUkx0bVQra1VxOXlUQy82Qm1sdFB4VwpwQ2tiWDBRWkdjYndheXp0QlV1QW5IR2ZXS1IvSFFSUDZOTU5tKy95V2YrZFM2NVNNNTk4bVIveUJ2UUh5K2J2ClZGTFlsa1I2SC9jaUtNUllrNzBPL0ZkTW93dmVjcWc1TlpPTjZQM0o5N3kzaGZJRUY1dWR5ZmY1RmI4cGxoOE8KeTJiRkFoWnFoc0VMdGRTVDlCckoxTitCQ1VJT0xIM3dQVkhaRFpnWFl5Q2REdEFZSVlxMDY3aVBGRHE0c3o1KwpiSTBoejVwMTdZWkhGVnpRT3dNeXZVVnd4WmhBa0Y2NTVkaWRBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBRHhFRkE3R0I5OWJKVWVVSi83Skp3TndYQWtpdmI3SEdFajRXYkUxMUNRSGtIM1BSdFJBQ0hVcEk1UHIKRnpwbFVSQVVVOXlEN1VpYTJaMHdvVnE4OGdDdWE0WkJiTnpXS1RJV0wwQ3RhcERBb3E1VmFySlYzR1FTUTBLQwpTRXg1Y3R4U0NXMG02TlYxM0dxR1pCQVJQb3VrYU1EVjMvc2Jpa0pXOXM4VnE3djBwQW8yZFRQdUN4T3hZdURYCkNaU2s0OTgzYkJZN1FjcEpxazZjZ0xHeDh2L08xV3BxYS9tY244UHlPd0lwTXBHeTN1ZTlpS3VYbzYrd0tzalQKcE9WNXRRSmREN1YxN2R5VWZiU1NZQkVXZnBLbVNEbXIyR01INmRLZm52bm4zK1JIdy9hdmpYZ0ViZ3ErSkNVRwpicGo2aWRQeGtSTFgrV2s2UHB3K29IQ201d1E9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRQ3FtLzhRT0N1MnVEQU5CZ2txaGtpRzl3MEJBUVVGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFEwTVRNNFdoY05NakF3TlRBME1EUTBNVE00V2pBbQpNU1F3SWdZRFZRUUREQnRuWVhSbGQyRjVMWE5sY25acFkyVXVaR1ZtWVhWc2RDNXpkbU13Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUURLOHc4Tms3VEJZOGZDTnpuczBkSnFhYnJvQVF5N0NkeVEKQS91VDdCVENmWkVOL0F6ZFNzcVpXUjA2UkxBc1FJVWlKTldaVFVadDR4bjg4YWFnRjZqWlJZcFB4cFpZYW15aAppTnNlaThKUExqL3BYME40SjRaZ0ZMcDVIRWcwNXJCRjVSMC9ENFJhTVpwVkpWS1VJVXh1STBoSjFVU3ZYdnM0CkV4S21QeXZ0SVY4U29YQTV4cGZ2aU1pMFhVRzM4YWl1c2VkUDVDa2s1eDZ4bXBlSGxiRDlCQjY1MisyVkJwWUcKaVFhN1pCUmF6NFRNblNoOFVSY3NQLzU3cFhqUWZ6N2VZeG51ekgxV2w1V25IUUt2VEFpemdyYmdzNUVDZFQ1bQp3U3o2eUhSTVJVVWVjZ0kzV0U3TU14ckpMS256d25SZG9MUFFkbEdIVllZQnFvS3A2em5YQWdNQkFBRXdEUVlKCktvWklodmNOQVFFRkJRQURnZ0VCQUc4c2hSU1JkYlhzK2hETXVZUE1RNTF6dnlIWlpzWW43c2ZTTHB5WHQxcmwKd1hVZ0xFNEtqcHgwVGF3QlVLbWdyeFFkejJwN3VKdjN1VUp5NDByVUF5VUlxWWJPbXh6QS9RdjB3WjFZaU9Rdgo0MEhlQVpIekI1NkkrYXNlSWxXbVBmWm1yZUthWW1kbDdBMHZXaTUycHBZL3FxVWhDaEdXNktPVXFucSsxVHErCi96c0RFL2x3VFdwZGNJVFJVMkR5NkFSU0xSeWFWSTN2VVZYSFBSak1OaVo1RkpOL04wVHlEc2Z3bmR5YnJpVVoKYXpDeXFxR0FOSnRjVDBqUXc4NEtPUHBPOXVrR28vT3FRNTFxMDRHMjlqMktRak1CbU9XWUV2V3N5NVE3ME9GdApTVVpUTFV0UXY4UGNmZmhUbG9obDVzSDVwayswMzhCRVQvSWZnckQrT1VjPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcFFJQkFBS0NBUUVBeXZNUERaTzB3V1BId2pjNTdOSFNhbW02NkFFTXV3bmNrQVA3ayt3VXduMlJEZndNCjNVckttVmtkT2tTd0xFQ0ZJaVRWbVUxR2JlTVovUEdtb0JlbzJVV0tUOGFXV0dwc29ZamJIb3ZDVHk0LzZWOUQKZUNlR1lCUzZlUnhJTk9hd1JlVWRQdytFV2pHYVZTVlNsQ0ZNYmlOSVNkVkVyMTc3T0JNU3BqOHI3U0ZmRXFGdwpPY2FYNzRqSXRGMUJ0L0dvcnJIblQrUXBKT2Nlc1pxWGg1V3cvUVFldWR2dGxRYVdCb2tHdTJRVVdzK0V6SjBvCmZGRVhMRC8rZTZWNDBIOCszbU1aN3N4OVZwZVZweDBDcjB3SXM0SzI0TE9SQW5VK1pzRXMrc2gwVEVWRkhuSUMKTjFoT3pETWF5U3lwODhKMFhhQ3owSFpSaDFXR0FhcUNxZXM1MXdJREFRQUJBb0lCQVFEQjBnRTFTVFFlWVdtOApQTHZ3Uks2OGUvOUpaUDlBZlhtTWZKRStRdi9NZ3RrT1R3SUdNVkJ0eFdLWmJGSUg0UktFZWtNWUptbTF0bWJ5ClgrSnZFRWxzUHZLSm43R2ovUGVFQ2N5aVRuMGkyNXVrQ0J2S1c0MEVvNmMyMU9ETXpPZlp5S2IydTUzOStWTlkKTDgyK3RGSm0rUUVucWlydmhUbE00MEl6VFM5cFJYc1JRUlZJQUVMdjVJbUxhOUw2dzFib0ljSHYxSGtVN3B3NQpWemtkUWswaWl3UnpJYWJYTmJNMWw1WEluM1IycVEzMEJaNXA2bWlRRHBDc0Fwc3JBVGE0M3Jzc2w1c2hXK2VICjVLYmo5SG1EZXAzWGJNYkZrQVpIdHhJZ0t4K0NQTm5uZ2NpNzlHRmV0Ky9OY0g4ZkhBaG1naHNQem9oa1MxN2wKZng0d1FtK1pBb0dCQU9yc3pFbHFsTzBFZm5iOTJDOWM0UGFMbG9rMmV1RWlrTk8zb2xPUTc4WWZUZ1p2YnEyZwpzeTZCMitFZ2llWUJ1ZzdHUnp3emRjU1g0MUtrMlBoeWcwaTFxTEJkR0s2T3p5R0VZQkdoaDkwUnJIZjVYTUdhCndwM250aEoyVW81MElwNnlETmpXNjJiSDFlRmdkc2x5TmhsQXJvTVMzM2dqWTZiSGF1b1lOVFBqQW9HQkFOMG4KN0Ezc3BCeHJmSHB4YjJ1M0taTGFnZllQSkt0QVlkalQrV3piOGh5WllWV09qbkFINkVmc3I2OXpmZFVzYXNBKwpxTHNjUGVmM213R3ltbzQ1NmwzaXR2d1F6alBvL3I5QnRsTVl6ZDdUdVdlU2RocHlOZGs5aG9lRkJpS1dCQ1VkCmVmdlZhSGFLKzV3dVh2MjllaFZBS3lmeFpyTG1BbUFEODRjMmlNeDlBb0dCQU9UNWVzQVFEeW5aV0g0WU93OG0KNHVuSzhpVzVJUm13ZkNLdmVKc2t5RjkrQWFuS0VNRlF3WFNTQThNdzJOZURWVnF6TFpsaXV1V3IrVmlDN2l0eQpTYjJqdWRCMFhPcytyR3FKd0sxT21NTURSK3dEODhHTVd5WlhReUpKaTN2bmZCcmJoaVFQam8rMk5TUWZ4b2ZnCk54Uno4K1F6ai9aajMrd2RzSHFNcjhackFvR0FQYytqcFR5bm5aM1pHNnZLdFhOcTlqV0dMMHlLTmliM2NnL0UKM2MwWGZURE5TSWxnZkNWcG9YaWduY3dNdG1FRXNSaVNOa0d0ZDhEM25PRGJXN2NLTHhWbmlVbjFLQU1OK0V5WQpkZDh2NHdDUUNFZWlKTUFaRnMrZ1l3NGw2ZEs5ODlXcU8xMnBKY0N3bERWTnJXT2cxSUdyemkwbFJBa1BUdUNyCjF2WENCRTBDZ1lFQTVJSURyb0VmUTlwcnQ5NmpaTVR3THZiK2JralQwcytPKzkwSFRiZVJNeGlEKzlkekNNRFUKMmR6enJMbUMwNHN4dk9jbEZnUUxZTjVOaVI0Q2VsVmRBNFpJME9TMGJ5ZFBOTHhBY3dWS0xFRytuSHNYZzQybApOOG84RkpxSFlCUHRkUVZIN2Fud2FUbml6djNtTVhsVERIUi9QQzk3QTIwNVV6b3hTWTdIYUtvPQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: default
type: Opaque
