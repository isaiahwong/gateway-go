##################################################
## Gateway Service
##################################################

apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: default
spec:
  ports:
    - name: http
      port: 5000
      targetPort: gateway-port
    - name: https
      port: 443
      targetPort: webhook-port
    # - name: admin
    #   port: 8080
    #   targetPort: admin-port
  selector:
    app: gateway
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-env-configmap
  namespace: default
data:
  APP_ENV: "production"
  ADDRESS: ":5000"

  WEBHOOK_ADDRESS: ":8443"
  WEBHOOK_KEY_DIR: "/run/secrets/tls/tls.key"
  WEBHOOK_CERT_DIR: "/run/secrets/tls/tls.crt"

  ACCOUNTS_ADDRESS: "api-accounts-v1-accountsservice.default.svc.cluster.local:5000"
  ACCOUNTS_TIMEOUT: "10"

  DISABLE_K8S_CLIENT: "false"
  ENABLE_STACKDRIVER: "false"

  PROTO_MAP: "proto/map.json"

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - name: gateway
          image: registry.gitlab.com/canderlabs/gateway-go
          imagePullPolicy: Always
          ports:
            - name: gateway-port
              containerPort: 5000
            - name: webhook-port
              containerPort: 8443
            # - name: admin-port
            #   containerPort: 8080

          envFrom:
            - configMapRef:
                name: gateway-env-configmap

          volumeMounts:
            - name: webhook-tls-certs
              mountPath: /run/secrets/tls
              readOnly: true

          livenessProbe:
            httpGet:
              path: /hz
              port: 5000
            initialDelaySeconds: 60
            periodSeconds: 120

      volumes:
        - name: webhook-tls-certs
          secret:
            secretName: webhook-server-tls

      imagePullSecrets:
        - name: gitlab-auth

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: default
---
# Role
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: default
  name: api-gateway
rules:
  - apiGroups: ['', 'extensions', 'apps']
    resources: ['services', 'namespaces']
    verbs: ['get', 'list']

---
# Role Binding
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: default
  name: api-gateway-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-gateway
subjects:
  - kind: ServiceAccount
    name: api-gateway
    namespace: default

---
##################################################
## Gateway Webhook
##################################################

apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: gateway-webhook
  namespace: default
webhooks:
  - name: gateway-service.default.svc
    clientConfig:
      service:
        name: gateway-service
        namespace: default
        path: '/admission'
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRQ1NmWmFUMU94Y1VEQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFkxTnpFMVdoY05NekF3TkRBeU1EWTFOekUxV2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRQ2dYWEJaTy85V0lwc0U2dG1YQzEyZ09yL3ZLL2RFZ2d2bUlGaXhIWnk5T3VNYk8vTTkKUWIwdnNvSk9JWmZTYW52ODhUSTFuVnlZV1VxU2FmZEFKdnJDUTYyVEVqYzhmRnhtQi9MVmNNNFJMWTlpU0xoYQp3OVF1SFBUd3ZlT1pkSHN5UThZd2kwNi8zUjBIMTY3NU5QWGMvRnl6N0FpSS9qVGdSdlZKcDFvQ1NicTdZck45Clc5MGhrdWFQZ1ZPRlJUUVo2SGdrSTN4S0lWdzBmV1RGV1lUWUMrOXNXMkVIYm44c1o1QllDbnlxc1R0SW9aZUMKSis5UlZJSGVrdjNYQjN0Z1JRMHlkUTZTdWZ2YnZlYzhncTgwNzhwUjFZZnhPR2tQRndnVi9FYTlKSmZiT1F1OQpDUnZZVzJmR0U2UDIyVkpqVDZDRVVHWG1NVERuaW1FeUhHekJBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBQ0VEYjdvMUJHZ0w0S2I0bVJQNGxaeDFDZkd1bi93TTV2TjZiek5qQm5ibSsxcHNON1l6YmZnNmRubkgKbDQ5OE1DZkVhaGZIOGNjZVNPcG5SUXJhZ25rOEprWVk1YnFWaU9qU3NMRUxwZEFzTCtmcGNLYTVSZFcwWTJUMgp3TUI0ZGJMdFgreWNSd1JXcGtKVnJFR3dwRURnT1NWTS9ORWVTdzBOOUlLa0FxYjE0MitOOWFCampwb0JqaEZ1ClFuMi80b3o2ZWxQS2ZHL1U4b2VrSThnN0NiMWtKaFNXSXEzUGhUdE5WVGU3L1lhSkJvUThVcUJVZmlGV3lrRGMKdlJrejdYL2R6VGVBSHF6Y1pBS2FBMWJ1YnFwVTdMRVV2TFNGRkVXbk5EbHBEV2pyRU9iNWFIRHFETHNiZllGeQo2cU1nZnNpZDlNQVRScWRMM0FVOVdWVk45d3M9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ['*']
        apiGroups: ['*']
        apiVersions: ['*']
        resources: ['services']

---
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRQ1NmWmFUMU94Y1VEQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFkxTnpFMVdoY05NekF3TkRBeU1EWTFOekUxV2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRQ2dYWEJaTy85V0lwc0U2dG1YQzEyZ09yL3ZLL2RFZ2d2bUlGaXhIWnk5T3VNYk8vTTkKUWIwdnNvSk9JWmZTYW52ODhUSTFuVnlZV1VxU2FmZEFKdnJDUTYyVEVqYzhmRnhtQi9MVmNNNFJMWTlpU0xoYQp3OVF1SFBUd3ZlT1pkSHN5UThZd2kwNi8zUjBIMTY3NU5QWGMvRnl6N0FpSS9qVGdSdlZKcDFvQ1NicTdZck45Clc5MGhrdWFQZ1ZPRlJUUVo2SGdrSTN4S0lWdzBmV1RGV1lUWUMrOXNXMkVIYm44c1o1QllDbnlxc1R0SW9aZUMKSis5UlZJSGVrdjNYQjN0Z1JRMHlkUTZTdWZ2YnZlYzhncTgwNzhwUjFZZnhPR2tQRndnVi9FYTlKSmZiT1F1OQpDUnZZVzJmR0U2UDIyVkpqVDZDRVVHWG1NVERuaW1FeUhHekJBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBQ0VEYjdvMUJHZ0w0S2I0bVJQNGxaeDFDZkd1bi93TTV2TjZiek5qQm5ibSsxcHNON1l6YmZnNmRubkgKbDQ5OE1DZkVhaGZIOGNjZVNPcG5SUXJhZ25rOEprWVk1YnFWaU9qU3NMRUxwZEFzTCtmcGNLYTVSZFcwWTJUMgp3TUI0ZGJMdFgreWNSd1JXcGtKVnJFR3dwRURnT1NWTS9ORWVTdzBOOUlLa0FxYjE0MitOOWFCampwb0JqaEZ1ClFuMi80b3o2ZWxQS2ZHL1U4b2VrSThnN0NiMWtKaFNXSXEzUGhUdE5WVGU3L1lhSkJvUThVcUJVZmlGV3lrRGMKdlJrejdYL2R6VGVBSHF6Y1pBS2FBMWJ1YnFwVTdMRVV2TFNGRkVXbk5EbHBEV2pyRU9iNWFIRHFETHNiZllGeQo2cU1nZnNpZDlNQVRScWRMM0FVOVdWVk45d3M9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRQ2FMMVFCTEFRcDNqQU5CZ2txaGtpRzl3MEJBUVVGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFkxTnpFMVdoY05NakF3TlRBME1EWTFOekUxV2pBbQpNU1F3SWdZRFZRUUREQnRuWVhSbGQyRjVMWE5sY25acFkyVXVaR1ZtWVhWc2RDNXpkbU13Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUNteFYwdEx4RWY5b1QxNlc1cXFHc01iZHJIRHdxZzNibWIKc1FNRUdlTVUwcGlQSmVwQXVkMGRZbWU1eDVNU0FKZm5BdU1OcFZpbHpNVGFUWnZ4cVdqYTBjS1V3ZWlCUUtaQgpCcUNoSDZmSUVickorSG56dHliMitWMTUyQ2l1WEVXcldxaGVXZ2J3Wk9UelZtWkw2T2RGRWRFeldDdGcrQnpJCmRSNUhpMGYyNzhqVHhtT2xXb1ZJMVpjczR3OVIrQkZXMjc3ZVVQazRmc3Bhc2NDSWpiUHNqZ0xzam5kSnJibUEKUEphc3JKQkMwZTQzOUNDcmxidkErSmxsRjZWU2VQaUJ3S1J2UlQ0aGFYdTV2bEtYY2RLVHBQSHhLNHB4V0V3ZwphTThDSmcyZnd3dEZaREdIMlQ2YzE4OS90YXM1SFNTK3lVdUQ1Ykw5MlNXdUFRSk55SktIQWdNQkFBRXdEUVlKCktvWklodmNOQVFFRkJRQURnZ0VCQURqMVRNYnhNK2hZVHpVbmlFODJlaVlQcVRVUFp2SlI3L3ZUZ0dNVEpoVU0KRUQrd1JGZ1p6VzZZbWttVTBkeGJ3ZDJ4K1lWL0VOamhLeDkySFVFZUpkK042QkEyVnZzMEZMdGVhQjg0azhobQpMSE9EMUdHdk1SY0Z3VDJwZGVjUHM3UzQrZFU4Sm9ycnRFVGtzUGgzRVVXRUQ3TTVqMTdQM05pTjByYzZMQmZhCjZiZ2NzTE5VQkhsOVhuMTlPYytMNmlPdEgzZWlMRldqTFZXQXA2bFBBcm90RXJ1N3dxNUw0UkFWR2RRazZRMGMKWFdKZkVUSXpGSGIydDg4RHFiMGdhcml4am9LNXN3ZHVzdzhCL1RJVjhoMmpJY3cwOFBHNnJqb0tkclAvWkVocAprR3ZGZS8zWStENHZjZDdPaG1vSjd5VW5HWjQyWG1CZzVtemJmNGJsQ3FzPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBcHNWZExTOFJIL2FFOWVsdWFxaHJERzNheHc4S29OMjVtN0VEQkJuakZOS1lqeVhxClFMbmRIV0pudWNlVEVnQ1g1d0xqRGFWWXBjekUyazJiOGFsbzJ0SENsTUhvZ1VDbVFRYWdvUitueUJHNnlmaDUKODdjbTl2bGRlZGdvcmx4RnExcW9YbG9HOEdUazgxWm1TK2puUlJIUk0xZ3JZUGdjeUhVZVI0dEg5dS9JMDhaagpwVnFGU05XWExPTVBVZmdSVnR1KzNsRDVPSDdLV3JIQWlJMno3STRDN0k1M1NhMjVnRHlXckt5UVF0SHVOL1FnCnE1Vzd3UGlaWlJlbFVuajRnY0NrYjBVK0lXbDd1YjVTbDNIU2s2VHg4U3VLY1ZoTUlHalBBaVlObjhNTFJXUXgKaDlrK25OZlBmN1dyT1Iwa3ZzbExnK1d5L2RrbHJnRUNUY2lTaHdJREFRQUJBb0lCQUdldVBBZGpRNXBEZ05ZQgprZ3Z0T09BNVM5S0ZuMjN6YXZsSVN6KzVlRnZ4c2JjTk0xMmFMOFdjOEMrbnk5OWRUeExuMEpFalFzR1JWTEVECm52ZlhBc0ZIdDFrVVZLQkd1UldrTVNqNnJTek5HUHVINXdtRnpFdXZMRlliOU82eG52NnhGZ3ZTbkkzSHJDODgKZjh5aHQyWlJkV1llWXBtZXB3WlpDY0lnN1ZTdkxUN0N0b05tYzRWQjVtbUtBd2draG9jSy9nelAvdzlsOTExMApJWTFZbDNjaUdLKzBMWklpK29palJTTTlaOGFHc01vQmJZK05qYll1YkhicG1CRTdTaDFYVFNUeFVDdW5OT045Ck05ZFFEa2RGVnZkOGljZHpQcWwxWTVTN3dmZGREYTlmMjZnSVRnc0ZZVElNT0dvUGpSNlo1R1RPZHRXaTZlVW8KQkhoaVo4RUNnWUVBMmJrb0NFZ0kvOXJTQWlGRVRNZm16VFAvVGZSSWZqMU5KSmpudE9EemJPWEt4RWIybmhCcwpCZzRPOVgrK2EvYjBXSGMwYzFNQXNVS0NLZGp6ekpCSHBNWUN5YmxnZmwrUk9Md3NSeFQrWnB4WUFWN3FENHdxCjJBb0tIRXVNY0xsaHZITTNWaUdLQ3pyMG80QzlSOFFoM2pJVDh1UmpveHhrRXlUcElJWHV4bzBDZ1lFQXhCY00Kem03aFNUMDVDb3NqMVVaUUd4anpCMEljSEJXbTdIVmRSeldqWlR6SnJnWGUxd1hJSVhRYUpBWmNaNGE4VUZVZQpCd05EUnVPZXlDNTFTRlJLeWxyZk52aDBSaUtDSjNxRUxRN3EwUURISlNzajNiRDRpVVVLYkJQWWpZeXB3aWJKCmFlYmN6enZEMUluUmtZSzBRWlhESm5kNnBuTDJ0WDZUYkZ2amNtTUNnWUJYaFpmekpFb0IyQXY5OFRPTWpmdFkKMkNNMFNoUHVNMlJVWnVjV0RpdXN4Zjhwd2NFWHIxQk5hczlXbndDRVZDVExmemZsZUNOYUhudEdxVUR3SmJ1MwpJQ1kwdzBGbjY3RHNGckRSN2oyS01DVXNmK1FsVmRwUE9GSHlKK2lQMCtYWEpKWEZHUHh1SVVnQWhoc1F3Mlk5CjlQR1IvWCtVTFRDSmhaZjFqQUY5YlFLQmdCQ0l1UVczQjd2N001SVdCV0Y0V2t6T243OWU3YXZZajRpa3BNYmEKV1BxeVUzY2UrNWs1M1pRa2pBZTVtWlVKSVZ2TXNZbDUxdlJsUVFBMEdxT01wL25FQzhwQXpOMFZEOUJ3WGpERwpienBNVEg1djBzaGdvYlJCWkEyVTVzK1lxcis2TVlXQ2Q5L3BkQ3U1cXpnUHcwODhaNFlZMFBpei9PVjAxTTF3Ck9nOXRBb0dCQUlsYUNMZ1FKNy9NWXdSWDBodXgzUDRBaEliWVVwUUpSRGFTL0ZkK0x6aDhTNUtOd2VxZkIxSnEKRTNxOS96ajVpZzJxZHlZY2VwZ0phdExNTVpPQVM5eitKTi9PY1FiNCtZcU1vYkF4Lzk1OVVJN3htZnBKT1BrRwpUbXBWajR5dGJpZFVjZGo3TEJNZTJlaUNNbUpkc1pJM2ZaYTZDQnRpU2ZUeHFnZ1I2WnFrCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: default
type: Opaque
