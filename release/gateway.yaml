##################################################
## Gateway Service
##################################################

apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: default
spec:
  ports:
    - name: http
      port: 5000
      targetPort: gateway-port
    - name: https
      port: 443
      targetPort: webhook-port
    # - name: admin
    #   port: 8080
    #   targetPort: admin-port
  selector:
    app: gateway
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-env-configmap
  namespace: default
data:
  APP_ENV: "production"
  ADDRESS: ":5000"

  WEBHOOK_ADDRESS: ":8443"
  WEBHOOK_KEY_DIR: "/run/secrets/tls/tls.key"
  WEBHOOK_CERT_DIR: "/run/secrets/tls/tls.crt"

  ACCOUNTS_ADDRESS: "api-accounts-v1-accountsservice.default.svc.cluster.local:5000"
  ACCOUNTS_TIMEOUT: "10"

  DISABLE_K8S_CLIENT: "false"
  ENABLE_STACKDRIVER: "false"

  PROTO_MAP: "proto/map.json"

  # Redis
  REDIS_ADDR: 'redis-gateway.redis-gateway-service:6379'

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - name: gateway
          image: registry.gitlab.com/canderlabs/gateway-go
          imagePullPolicy: Always
          ports:
            - name: gateway-port
              containerPort: 5000
            - name: webhook-port
              containerPort: 8443
            # - name: admin-port
            #   containerPort: 8080

          envFrom:
            - configMapRef:
                name: gateway-env-configmap

          volumeMounts:
            - name: webhook-tls-certs
              mountPath: /run/secrets/tls
              readOnly: true

          livenessProbe:
            httpGet:
              path: /hz
              port: 5000
            initialDelaySeconds: 60
            periodSeconds: 120

      volumes:
        - name: webhook-tls-certs
          secret:
            secretName: webhook-server-tls

      imagePullSecrets:
        - name: gitlab-auth

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: default
---
# Role
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: default
  name: api-gateway
rules:
  - apiGroups: ['', 'extensions', 'apps']
    resources: ['services', 'namespaces']
    verbs: ['get', 'list']

---
# Role Binding
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: default
  name: api-gateway-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-gateway
subjects:
  - kind: ServiceAccount
    name: api-gateway
    namespace: default

---
##################################################
## Gateway Webhook
##################################################

apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: gateway-webhook
  namespace: default
webhooks:
  - name: gateway-service.default.svc
    clientConfig:
      service:
        name: gateway-service
        namespace: default
        path: '/admission'
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRQ1kreUxGY081Yk1qQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05ESTRNVGMwTlRVeldoY05NekF3TkRJMk1UYzBOVFV6V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRRG5HUEUwQzc5S2ZXdkpORUlJdUhuOSsxNG42dHllQndzVmlNNVcrd3hZY1ZTakxuSXQKWHYwZnh4YjUrQjNWSjFJTy91MEhvODBsZjh0MGdEa21HajRRVWFJVGxNQU83dnVkd053OVJ6bGRsUVlzaFo3dAprcWlXNm1yUHcxdkJuVVBnamJ2L0xaWitzTWM2NkUrRDlibVBibCtLY3BYN0ZGZmpEUlZhRWlWODhudysxeGlDCjRrRHU4ZjRkaDhLbFBYMFBBL0VBdml0MTU3MnJIT0JTL3V3SEkzcEVZU3RkNnZ4dzBkTXdMYS9tbzBZa21uY0EKend4bXlFb2ljbEZVcnpQUXpTaDZ6V2RlbXhVZ2F2YVpNRGZ0QmMzV0pWU0YrVFUzSCtOMUxOK21YV3g3SW52RwpFdElid1VxYmlURmV5Q0Z4bk4xdHROQTF1S0xTMC9LeFN5MXhBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBSmlGU2Uyb3IvMU9uNm14OHdOQVlpbmk1bzZxRzc0VjArSXVVdGErVHBYb2pDT3VGZnFGTDFQdytKbGgKdUNnSUdHNHphOCsxUmdTQis2NDkxWkttNFAwQ2dNaFJTWnZ3d0crTjFRY04zK1dKdmJPQmpCcm85bGczNFI5QgpQVFJSQmNzRWY0WThvREhXR0xTN2dlWGxQY0lPY1UyM0IrMFVHTzQ1Z0FpaTJZdW5VTlBTLytyQWNYMlFxelcyCklFWUM5eWRDUlVZbEhXVzh2bGdjUE1Zb2J3TW95RmpSL3RBTGxvV28rQ0NUMHU4NFd5dEYwYmlZM2M1Ry9lTkYKQTFGMnZCL3JJQmZIRld3dklYNzdIaW13b2h0MlpPaWMwak11aG9QblZmNTNPTVBhWmpXUW5QNEdqYzlQencrVQpSL096cXRqWVFuQXB6QXdlaldkVCsvekY2WEU9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ['*']
        apiGroups: ['*']
        apiVersions: ['*']
        resources: ['services']

---
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRQ1kreUxGY081Yk1qQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05ESTRNVGMwTlRVeldoY05NekF3TkRJMk1UYzBOVFV6V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRRG5HUEUwQzc5S2ZXdkpORUlJdUhuOSsxNG42dHllQndzVmlNNVcrd3hZY1ZTakxuSXQKWHYwZnh4YjUrQjNWSjFJTy91MEhvODBsZjh0MGdEa21HajRRVWFJVGxNQU83dnVkd053OVJ6bGRsUVlzaFo3dAprcWlXNm1yUHcxdkJuVVBnamJ2L0xaWitzTWM2NkUrRDlibVBibCtLY3BYN0ZGZmpEUlZhRWlWODhudysxeGlDCjRrRHU4ZjRkaDhLbFBYMFBBL0VBdml0MTU3MnJIT0JTL3V3SEkzcEVZU3RkNnZ4dzBkTXdMYS9tbzBZa21uY0EKend4bXlFb2ljbEZVcnpQUXpTaDZ6V2RlbXhVZ2F2YVpNRGZ0QmMzV0pWU0YrVFUzSCtOMUxOK21YV3g3SW52RwpFdElid1VxYmlURmV5Q0Z4bk4xdHROQTF1S0xTMC9LeFN5MXhBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBSmlGU2Uyb3IvMU9uNm14OHdOQVlpbmk1bzZxRzc0VjArSXVVdGErVHBYb2pDT3VGZnFGTDFQdytKbGgKdUNnSUdHNHphOCsxUmdTQis2NDkxWkttNFAwQ2dNaFJTWnZ3d0crTjFRY04zK1dKdmJPQmpCcm85bGczNFI5QgpQVFJSQmNzRWY0WThvREhXR0xTN2dlWGxQY0lPY1UyM0IrMFVHTzQ1Z0FpaTJZdW5VTlBTLytyQWNYMlFxelcyCklFWUM5eWRDUlVZbEhXVzh2bGdjUE1Zb2J3TW95RmpSL3RBTGxvV28rQ0NUMHU4NFd5dEYwYmlZM2M1Ry9lTkYKQTFGMnZCL3JJQmZIRld3dklYNzdIaW13b2h0MlpPaWMwak11aG9QblZmNTNPTVBhWmpXUW5QNEdqYzlQencrVQpSL096cXRqWVFuQXB6QXdlaldkVCsvekY2WEU9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRREpGcXpqODBROVhqQU5CZ2txaGtpRzl3MEJBUVVGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05ESTRNVGMwTlRVeldoY05NakF3TlRJNE1UYzBOVFV6V2pBbQpNU1F3SWdZRFZRUUREQnRuWVhSbGQyRjVMWE5sY25acFkyVXVaR1ZtWVhWc2RDNXpkbU13Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUN3RWhJbWJQbFRQNXNyOUxpaGg5cmg4ZzBHODdOKzhjMzMKRkFKZWpTZ0RlbWFNaFRPUGJzUDBzMk9mc2dJTUtFTXlDWld5aCt6TFpFOWs3QkkwYzdYcVZISjFhMzFXZGRSeQpZTmlmV2xiQ2VHRVZQMFhTMm42RXBjckFpNFkxVVRPTFppWThBKzNMZURmeVdNdGZYUVVaaVJCRDhXR0FvMElVCklicGhMQklrWU1DczRJSDJtcjgwWlRTSWN3M2xzUzVhM3JGcnRlSHJXekUwOFNDWUhRcFlOQUZETGhxOTZwN3AKa3Y1RWE3YXVRdytpTzBiYUtlTGZXbjlWMDZOVVo5a20rbUhkbXZBRWJmM282TUlqM093SXM4b3cxZWdlaHFjSwphbVZ5a041SHpvR1NyZTUwWFUvSHg5RkIxVWd3UXM1VFpVOXFhQlhBRlozUEdKdHc5dVk3QWdNQkFBRXdEUVlKCktvWklodmNOQVFFRkJRQURnZ0VCQUlUVHh5ZVBoYXcyc1laSGpBckFtTDVwMGNQSWlaWmp5dHk4NWZmZ3UzK20KZDJ6cVAvdlBiVVc1SFovWDV3WnZISWxkaUNScnpweEdtOXlRcUdtK0U1MUdlQS9uelZ6ZldldVJPSU02ZWZPSwpDNlh1anY1NHQ3aE4rZit3QWJvWFpVL1FURml6MjAvZ2RyY2VQTFdabkE5eGRTcGJCelpWUkdhNjdvYmMvWEFzCk01eE9sbnRhdUZiemhya2wyVDRPK3doRnZyb1hyS0xpRHk3blI3WVJNL1ppS0VKL09IL3RTZTRTWm0vNHp4NlcKU3lPQzIvdHdyNXJSaUZCQkR6QS83blNqMjgrOTFCWm1OUkxmdzdPVVJKY3FMQ3YvS3RIbHpSUVFQb0FaMS8yYQpnZkQ1a3ZZUVYySTlXbG1pcEF3aFdXTThRa3BOaDhTWG9rWG5xV3dUVUpnPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcFFJQkFBS0NBUUVBc0JJU0ptejVVeitiSy9TNG9ZZmE0ZklOQnZPemZ2SE45eFFDWG8wb0EzcG1qSVV6CmoyN0Q5TE5qbjdJQ0RDaERNZ21Wc29mc3kyUlBaT3dTTkhPMTZsUnlkV3Q5Vm5YVWNtRFluMXBXd25oaEZUOUYKMHRwK2hLWEt3SXVHTlZFemkyWW1QQVB0eTNnMzhsakxYMTBGR1lrUVEvRmhnS05DRkNHNllTd1NKR0RBck9DQgo5cHEvTkdVMGlITU41YkV1V3Q2eGE3WGg2MXN4TlBFZ21CMEtXRFFCUXk0YXZlcWU2WkwrUkd1MnJrTVBvanRHCjJpbmkzMXAvVmRPalZHZlpKdnBoM1pyd0JHMzk2T2pDSTl6c0NMUEtNTlhvSG9hbkNtcGxjcERlUjg2QmtxM3UKZEYxUHg4ZlJRZFZJTUVMT1UyVlBhbWdWd0JXZHp4aWJjUGJtT3dJREFRQUJBb0lCQUcvdnZTeEN3YXZrVjBGMQp2dCtxNEVRZlA1cjQybGZOWU5WQkdsU0VSemtXMnhWaEphdDlqd1VGKzBNdXgxQjFWR3IrWHZaMnBkdVU5VWpECk1MdTZDS0JtZWJJZTJUdGJnK29IbWhDTlBYVTdWUFZPR1pUNHBkQ3RHcDZZMVlVV0Q4QUMvREhSaVo5KzJZcXcKV3ZOUXp3b3g4bTVQaWw1ZTdJYWgvcjBDYUxKSTViL0pneUkrdHVqMGlleHE2Zy83UlhCNjJwanBQb0Z4YVNVVAp0OVliUlNmc29Ob0ZVb0hnQnZ4TzJTL0FSQlM2QWxvU2tKekNjNHpKalVWODU1aW9Lblhlc1lkSjRWVUlBU0wxCnd6b0puUFBqOVpYcmdTNXlzVzYzd3JDSTh1T09wVkNGK1ErdWI5QTBiQTdhL1hPM0RWUUdHbnAveG1pV1JNaUQKT3F3V2lERUNnWUVBNWpUd0o0bmRnS1FXMXdmdU1FUTIrT28ycXZXSnJ4Y1VzVjRMemVMaTVQNndUK3hVRXVhUwpMMndRbkV1aEFzck5DWmlrbUszejJJSGxNcDFhRmVqMzlLbFdwVEZYUXpLL0xLdm1yT1E2L0RaZllubjBhdkxwCnVnTzVmbWROMXhOMWlMdVJCMmNUZEp2N21veStaMmRWS2FySTc1RDZqQklUZGE5MTdqUmVKZGtDZ1lFQXc4eFYKcW9xRDR3d1VSYXMwUG9Cb01QVFBwaVZYQlhscndyZHdKeUM3ZXd4a3AwUE5yd0FWckVrWUFSdzZvaW1VSDY3Ygpaa2gwcjNEcEJyVG8rbEVjUmxnRWRxSi9wc0ZYNEE3MnVpK1kyWHBnR0Q3VmdEc0JUaDhDUG1IMEJkZnZUMnIxCnluUGJnOFY1NURnYjVXSHhCYk5NbHBwbm9LdFUza2lMTkYxNnZETUNnWUVBcjR2KzlxZXpPYjNuak9LSFNGYzgKZEdSbWU4Znh6b3NUUkk0ckFqM2FPRFhmelpLeUtoZVpzbi85eXJJQmZsZVlNNUVyTXlLenFJNmxjUXQ4L3VoQQo3Vm1Vc1RRSER6OUxlWTA4d3VybjhCeW1jRG4vb083TVBRVktGcEpBVVpxTkxrK2FNTUx4bXlLM293dGd4d21OCmI5REVtYXM4NUVPRWcySGgxRndxejBFQ2dZRUFwLytqWVhrSVFNQVVoTktwT1Jla1RwMC9yaWRMeTM2clg1OVYKczd6NklGSTU2dXJhaU5WaHd6blVSdCtaejVvdFppSDZUb0RNM2R2YmxjMlVPWE51OTB4K1IreVY2dGJxTjIyZgpkWkZ4Yk9qN210SVBEcitTRngyMEp5S1U1bzZvMzFPL0liN1hFdkZWN09QWHk3R0Z4SVpicUwxRFBUREUyUlVWCm5CQzVSdEVDZ1lFQWxxRmlmdk1sRVdRTnJnYno0NktxMjdnTENSN0k2b3Q3TW1EM25tNUpQUmdTRE5XYlM1TEEKYlZpcU9kRXl1VFQ1U05lY2JzTTQzM29TVUNFbCtENm5jWXZPcEN1Szd0VGpETHBnNDdzUlNSbUZ4UzgvaW8weApDaDMyNWZibVRWNldydHZqT3EwczVMSFB1RUs3MGZqbVpjR0xLZVNMTUtJbjZPaUFtUXVKMWxJPQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: default
type: Opaque
