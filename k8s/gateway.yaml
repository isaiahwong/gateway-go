##################################################
## Gateway Service
##################################################

apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: default
spec:
  ports:
    - name: http
      port: 5000
      targetPort: gateway-port
    - name: https
      port: 443
      targetPort: webhook-port
    # - name: admin
    #   port: 8080
    #   targetPort: admin-port
  selector:
    app: gateway
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-env-configmap
  namespace: default
data:
  APP_ENV: 'development'
  PORT: '5000'

  WEBHOOK_PORT: '8443'

  DISABLE_K8S_CLIENT: 'false'
  ENABLE_STACKDRIVER: 'false'

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - name: gateway
          image: registry.gitlab.com/isaiahwong/cluster/gateway
          imagePullPolicy: IfNotPresent
          ports:
            - name: gateway-port
              containerPort: 5000
            - name: webhook-port
              containerPort: 8443
            # - name: admin-port
            #   containerPort: 8080

          envFrom:
            - configMapRef:
                name: gateway-env-configmap

          volumeMounts:
            - name: webhook-tls-certs
              mountPath: /run/secrets/tls
              readOnly: true

          livenessProbe:
            httpGet:
              path: /hz
              port: 5000
            initialDelaySeconds: 60
            periodSeconds: 120

      volumes:
        - name: webhook-tls-certs
          secret:
            secretName: webhook-server-tls

      imagePullSecrets:
        - name: gitlab-auth

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: default
---
# Role
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: default
  name: api-gateway
rules:
  - apiGroups: ['', 'extensions', 'apps']
    resources: ['services', 'namespaces']
    verbs: ['get', 'list']

---
# Role Binding
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: default
  name: api-gateway-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-gateway
subjects:
  - kind: ServiceAccount
    name: api-gateway
    namespace: default

---
##################################################
## Gateway Webhook
##################################################

apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: gateway-webhook
  namespace: default
webhooks:
  - name: gateway-service.default.svc
    clientConfig:
      service:
        name: gateway-service
        namespace: default
        path: '/admission'
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRREpQSU9FNVd2WnVqQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQXpNVFF5TlRNNFdoY05NekF3TkRBeE1UUXlOVE00V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRRGtTakk2SDhCbkN6dFZydGprV0pldWdQRURkejNuWU5oaW1LbU1CNmNUSkl3LzFhSkMKSW1rYzFHVENhY0tlVXJWRkRLaThYcitUU05kZE5sRmgvMGxRdzBjOWtNdGx5VkNEanZGcU9KZ3VBZDZ5RDQ1QwpVUmVvViswcDZGQ0F3OHlxN3JGSkhVWStPSWU2ZW1DMjhmZDR2VklYMkxOOEZhYlBBSEl4MlNnSUN3MDlUMFgyCjdpU3pHYzBGamRkbllQMW1XT054ZzNOdGE2Q2lZdVNaSnFZSFhkbXZXTDJiTzhCU1IvOVMxZlh6THZydnlzazYKN213aUlEOXJXNDA4MytZeGgxWm1heUlhNXdRT1hGMldLWjNNdzZVNk5XazloRGcxY0hodHREdk9nK3ZiYmZSawpZdU9RSjdqWHFFVk5ycFVYZy9xbGJ6ZFhpdnpZb1Y4ZFpkZ0pBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBQVN1SVYyT0V6VlNtSmZDbW5lUUVyTW1vdDJ1ZkhWSXY0R09pKzdQZGt0bE9yNDN6dVpGUHVrelh4K3cKT1lKRzNuMEIyZHVKcVVWMkwvRGJHaFZJZ3IzdXJUVG8wUDY1VW13M1F1U2FIUExBYjRoc1RoWWVPQlVzeEZZbQpxc3E1dVZmODFBOGZObEpOL1JaYTAxREgzVUVxT3c2SUtwbzdxVXdIanFLbFJDVTBUbDdoRFFqaXdLdEhGdUcvCnM5QUYrTVBBcVg3b2xGeVJoNjZRcWtnNWoyWUxROXdNRks4N2FwRkNaZWNMUTgydFdpVjdQY2Zmb09iV3MxU0cKQml5VHNsYk1udGhNdFFZUHdyRWZ5aGVrK2cvL1k3K3RvMVFMcHQ0NEVpV1QzVjAreDR4N25JWXdJTFBGTUxiWgoySUJBN3lFeVc5KytGWEJjWXBwVm0yOWxzMEk9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ['*']
        apiGroups: ['*']
        apiVersions: ['*']
        resources: ['services']

---
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRREpQSU9FNVd2WnVqQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQXpNVFF5TlRNNFdoY05NekF3TkRBeE1UUXlOVE00V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRRGtTakk2SDhCbkN6dFZydGprV0pldWdQRURkejNuWU5oaW1LbU1CNmNUSkl3LzFhSkMKSW1rYzFHVENhY0tlVXJWRkRLaThYcitUU05kZE5sRmgvMGxRdzBjOWtNdGx5VkNEanZGcU9KZ3VBZDZ5RDQ1QwpVUmVvViswcDZGQ0F3OHlxN3JGSkhVWStPSWU2ZW1DMjhmZDR2VklYMkxOOEZhYlBBSEl4MlNnSUN3MDlUMFgyCjdpU3pHYzBGamRkbllQMW1XT054ZzNOdGE2Q2lZdVNaSnFZSFhkbXZXTDJiTzhCU1IvOVMxZlh6THZydnlzazYKN213aUlEOXJXNDA4MytZeGgxWm1heUlhNXdRT1hGMldLWjNNdzZVNk5XazloRGcxY0hodHREdk9nK3ZiYmZSawpZdU9RSjdqWHFFVk5ycFVYZy9xbGJ6ZFhpdnpZb1Y4ZFpkZ0pBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBQVN1SVYyT0V6VlNtSmZDbW5lUUVyTW1vdDJ1ZkhWSXY0R09pKzdQZGt0bE9yNDN6dVpGUHVrelh4K3cKT1lKRzNuMEIyZHVKcVVWMkwvRGJHaFZJZ3IzdXJUVG8wUDY1VW13M1F1U2FIUExBYjRoc1RoWWVPQlVzeEZZbQpxc3E1dVZmODFBOGZObEpOL1JaYTAxREgzVUVxT3c2SUtwbzdxVXdIanFLbFJDVTBUbDdoRFFqaXdLdEhGdUcvCnM5QUYrTVBBcVg3b2xGeVJoNjZRcWtnNWoyWUxROXdNRks4N2FwRkNaZWNMUTgydFdpVjdQY2Zmb09iV3MxU0cKQml5VHNsYk1udGhNdFFZUHdyRWZ5aGVrK2cvL1k3K3RvMVFMcHQ0NEVpV1QzVjAreDR4N25JWXdJTFBGTUxiWgoySUJBN3lFeVc5KytGWEJjWXBwVm0yOWxzMEk9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRRGxoUGc5cWJpZXdEQU5CZ2txaGtpRzl3MEJBUVVGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQXpNVFF5TlRNNFdoY05NakF3TlRBek1UUXlOVE00V2pBbQpNU1F3SWdZRFZRUUREQnRuWVhSbGQyRjVMWE5sY25acFkyVXVaR1ZtWVhWc2RDNXpkbU13Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUNyK1RySytOQkwvVzhyRXVIQ3hUcllpRWs1cXJtOHp1bGoKOE9RS093RVFKNExnR1lTSDhzc3pieGxlUWg5UnRiNXJENUhLMHBEL3d0S010MGxzQ1BQRVZYU2hVK3hSNjRmUQo0cDN5a1BOV1AyRlFqNjRDdkkycE5QRzdkTmtDZ01CaE1IcWl2R0xqZ0dRRWU5UkIrQXQ2bkdpYzhRWG55UVBSCnNxanIxckVZTGgvNno5b09hRWVuR1lDeThMK212ZFI1OVBIZ3RJUlNTT1FLRExiMXdKbFZ6NktqUWpJT0dsRVUKaktWZ1VEN0RHcnZqalFhQnE4eDRsTlBLY2t3Z1FieFBCcHp6YUhyNUtldVJWdVJVOElwd2t1UHJyMGVlTEY2MApVTDBqR2VPeFVvUTcyR1BDaDhmOUNQQVk0Q3FpWENkRTFTZ3I4elhJMndVVjdZSFAzbWFkQWdNQkFBRXdEUVlKCktvWklodmNOQVFFRkJRQURnZ0VCQU5UV0crdisybnNKMXg4MVZvVUxoQUs5V2J5N3JLdGI2VkFERVpUZGlpangKTTNwRTZQazV0V0JvRVdnNGVsUFdyajZtZDI1M1Z1NWtNRm9ubTlYM0Z5NmNtNE9xYWNwNWhqNGFDbUlaVzB5WAphTU1VNXcvb242enpGYXBqYmhqMWJiTEVua1FNeUFkei9qSE1SejBxVTU0TmlMbWo5TkJpN0xjOUlNSlc5VnRrCkhPTUdxZ1ZjaGMyNEN1djVpZy9aZ0M5ZThYVkJXR3lJNnZLc2MwcFpNY1lwRTUwNzNsVWhTdXlBeW9wUkx2cVYKVjZOTXRxMGVwbGxmb1pSRnpxalpTZXpHKzJPODJzRUZaWGlxRTFYeFlCQXFBNmVlWE9sUUIrZVU3Q05sWHpyegpYcXMxYkxSU2FXWTdKK1NSeXp3WG5XMEVwN2FuZXR6d2tNOGxOZTh1S29ZPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBcS9rNnl2alFTLzF2S3hMaHdzVTYySWhKT2FxNXZNN3BZL0RrQ2pzQkVDZUM0Qm1FCmgvTExNMjhaWGtJZlViVythdytSeXRLUS84TFNqTGRKYkFqenhGVjBvVlBzVWV1SDBPS2Q4cER6Vmo5aFVJK3UKQXJ5TnFUVHh1M1RaQW9EQVlUQjZvcnhpNDRCa0JIdlVRZmdMZXB4b25QRUY1OGtEMGJLbzY5YXhHQzRmK3MvYQpEbWhIcHhtQXN2Qy9wcjNVZWZUeDRMU0VVa2prQ2d5MjljQ1pWYytpbzBJeURocFJGSXlsWUZBK3d4cTc0NDBHCmdhdk1lSlRUeW5KTUlFRzhUd2FjODJoNitTbnJrVmJrVlBDS2NKTGo2NjlIbml4ZXRGQzlJeG5qc1ZLRU85aGoKd29mSC9RandHT0Fxb2x3blJOVW9LL00xeU5zRkZlMkJ6OTVtblFJREFRQUJBb0lCQUVSd05jNkt3RkpOZEUwLwpBV3RDbEUyUnh4cFU3Ly9NbENMNnZiVzRqNDYvT3AwMmFvQ3p4ZHdkTFlwT1pDcGZXbjArdi9Wb1lOMzN5VlRJCnFFWi9OWXQvdXA5dFI1RytXdGx0SmhCZlVRZVV4NFNJK1dZTFpaRGVDZ2xnMGUvbUR5bGVZcCthdXZ2d24xME4KYm9ZbVVXTWxGWmpIYm1NMG92bHowVGV4dzk1cjdVRnc2MnhxQWlJV0dkdjZjMU1WZTkvT0x4SlVleXVKSDMzNgpneTRyOXR1MTZZVk5ya1NKM2JiVGdiMFdUbEVkUHA5Z1lyb3o1UzJwT3ZZdEpxL2orOWVsY0tucWcrNHg0S3g4CkpDOGZlb1NGQVJrbENmK1ZSTTBFRG5KLzZyZUFaZkxqUkEzRnhDQkRMRzFXdUhkWG5KbFNVaFEzQ1hBZkUraDQKeGJMcmtrRUNnWUVBNGtXbUhnQ08vR3dUY3Y1d21BYTRVUnc5MFcwZU1udHNzY2pGNnQ4NHFKcitsajhNOWVTegpGRmNiaUxLYnhUZ2lVdk9KVjBtTFN2Rm1xa1RJMmhsUExwY3d6NG9xd1dnU0pRdWJNck43R0tkY3EvODlXVHhpCmVxeStPSitLL0luMWxnYlBEeGtQTWNMQ1B3azRiSGVBTzhWemNIOWs3RjZqdlM0cmhyR3lvSzBDZ1lFQXdwRlQKRzhxOFNKSFNDcFU4SmtadFJpUzhRRzk0RXErTHYySGZ3SE1vdjZVdmNVaWF4WUpJTUNqU2NwR2N4Q1diOWFoSQpOenphR3R5SzJEUzJOUDVWSjFYaC9ZT0VBWUlKcEhCczVjN0ZVVHpRZzJKZ3VSdFVidzM1TnFRNGl4dm9PQW1BCmxLaS9GOVVMa00vY3hMdkJmTFc0dFgvaVRUdEszTmRvZXhpcGE3RUNnWUVBdFNrY2FoTDZhQ0ZEcFNNUUZMZjAKcElRZS9ta0Y3MWNnWEdzcUF2VjdrSXFmNEwxVWJCOFNQZXZNRUxNbndreENOdlhqZFM1ZHhyL2wrZGNlbEhnRgpESUZpUkJnVVNVdEFrOFpxR0xyWWlKR2V3ZHFXVExickJkcitaYWxmQnZpUjF1OVdvbmptMEdsbFNrRGdtdjlHCmZSU0dhNENqMWhlanN4aWZJclZ0RmZVQ2dZRUFpaTVMcCtGRDl3WVk5Z3Ntdk1nbnN6bER1VDl4TjFRVkc4YVcKOGtiWEdjUm0vVDFqTGdKbzRrc2JxdUpmUTY2eUpMVnZGRXZUV21CbSswWDBZWTUvUzRCakQzam50MnB6RHFZSgpzT3c0bG9scVRPVUJiSFZNY2RLcXUzUEY5SVhOVm43cElxcjFqQ2R5SDFhQW8vZjBZbTFzMFBvUjdtZTlzem9JCnFlUEo3d0VDZ1lBRkNLak40dXowMVZLQWVwYjdTNmNjeUdDWVZnU2FQSzFvL1lqZTk0ZkdDdWJJdEt4MUJHbXQKMkZRbFR0enBDazh2M1VpNEgrZE9ReHpmMFEzUzljQjZhN2pjR2dydEluaUxJUFpKUWJFb2hYQU5LMDAxWk9vTwpvcjNmVHR2ZUUrc2JCak13SHZXbmVMa1JKZ3RsWkVseUFYc3RDalZaQlVYR0lPRmxLNE1qU0E9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: default
type: Opaque
