##################################################
## Gateway Service
##################################################

apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: default
spec:
  ports:
    - name: http
      port: 5000
      targetPort: gateway-port
    - name: https
      port: 443
      targetPort: webhook-port
    # - name: admin
    #   port: 8080
    #   targetPort: admin-port
  selector:
    app: gateway
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-env-configmap
  namespace: default
data:
  APP_ENV: 'development'
  PORT: '5000'

  WEBHOOK_PORT: '8443'

  DISABLE_K8S_CLIENT: 'false'
  ENABLE_STACKDRIVER: 'false'

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - name: gateway
          image: registry.gitlab.com/isaiahwong/cluster/gateway
          imagePullPolicy: IfNotPresent
          ports:
            - name: gateway-port
              containerPort: 5000
            - name: webhook-port
              containerPort: 8443
            # - name: admin-port
            #   containerPort: 8080

          envFrom:
            - configMapRef:
                name: gateway-env-configmap

          volumeMounts:
            - name: webhook-tls-certs
              mountPath: /run/secrets/tls
              readOnly: true

          livenessProbe:
            httpGet:
              path: /hz
              port: 5000
            initialDelaySeconds: 60
            periodSeconds: 120

      volumes:
        - name: webhook-tls-certs
          secret:
            secretName: webhook-server-tls

      imagePullSecrets:
        - name: gitlab-auth

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: default
---
# Role
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: default
  name: api-gateway
rules:
  - apiGroups: ['', 'extensions', 'apps']
    resources: ['services', 'namespaces']
    verbs: ['get', 'list']

---
# Role Binding
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: default
  name: api-gateway-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-gateway
subjects:
  - kind: ServiceAccount
    name: api-gateway
    namespace: default

---
##################################################
## Gateway Webhook
##################################################

apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: gateway-webhook
  namespace: default
webhooks:
  - name: gateway-service.default.svc
    clientConfig:
      service:
        name: gateway-service
        namespace: default
        path: '/admission'
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRRFVUS0g1bWpQN2pEQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd016RXpNREl5TnpJMldoY05NekF3TXpFeE1ESXlOekkyV2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRREgwTnN6dkczNWQ5RnpXUUltbmo3ZUFTQXQvbllEMVN4cDBGekZIbG9xTWRmbVpsZnMKckc1ekVyTW5QQU5yeW9qRm9WU0ExM0tCVXhFdmtaZWlvR21MdjJ3eWtYQlpzV2w1Nlc1NVJSSmdoVDVYSERXdAp3UEUvVGZLSDdrdzl4azJMNjJTWXpOM1hjTVFBYmlIQ0UwNjd1dnlrelB1WGdiWFlnaFZ2M3VRRHN1dlFqbFI4ClNPRVdtcXhYOW0ydS83bTU0emFaVVhIVXA4c3RkdWljb2J1U1AxVTNYUmZsUHJNU3haQjdLb0FKUzBJQ1l5dWEKUTNvUmNMbEZBWkM0emhuaUEwTGsvcWkySUJvUW45VDBQUE90ZnJLdU1lVjc1TEk3aTFVZUlVc1hNSW1lSXdVKwpzektHbTBCTnJVNDdoOWFYUCtxZVdwMTNUU05VdlV1UFN6UXZBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBRjArMDYxaStIVTVORmRUc3RhUTZGREgra3ZHRWttNHBSZ01iYzFXY2diWGpoTEdhZnBITDdWQU53OXMKcjI2dFh2UktRaDhDR21iQVM1ckJpM2VBMnRoRnNXb1RKQnNQU0dTa2VaM0pPNUNxcU12OFRyZ2xVcytYNFdaagpod2xuaXNtWFRDZm5JM1pjNUNaRUNUdDhFY2xML1RKMlR5MGpVTFBlTkhpWWxHZmJMOHpMN0RDVDFVTmo2L0h2CjZsLzJjNkhkYTRqYXZldElIN2JrNEtiUVpyM3haSWU3NUk3U0VmU0NyaDdQbm9KOEd0TGhiQzViMkdWOUNxck4KSkpYUENtbzhwN21CZ0pPUndwT1ZoRkRwSVZtd2ZMaEFpV09uSVlYcFJVbUhmdXZjbmJFZkxYb1REZlUraXJXMgpYb2ZRTGtlWUVBQ1NVTTBFWCs1d2IxYXN3OTA9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ['*']
        apiGroups: ['*']
        apiVersions: ['*']
        resources: ['services']

---
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRRFVUS0g1bWpQN2pEQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd016RXpNREl5TnpJMldoY05NekF3TXpFeE1ESXlOekkyV2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRREgwTnN6dkczNWQ5RnpXUUltbmo3ZUFTQXQvbllEMVN4cDBGekZIbG9xTWRmbVpsZnMKckc1ekVyTW5QQU5yeW9qRm9WU0ExM0tCVXhFdmtaZWlvR21MdjJ3eWtYQlpzV2w1Nlc1NVJSSmdoVDVYSERXdAp3UEUvVGZLSDdrdzl4azJMNjJTWXpOM1hjTVFBYmlIQ0UwNjd1dnlrelB1WGdiWFlnaFZ2M3VRRHN1dlFqbFI4ClNPRVdtcXhYOW0ydS83bTU0emFaVVhIVXA4c3RkdWljb2J1U1AxVTNYUmZsUHJNU3haQjdLb0FKUzBJQ1l5dWEKUTNvUmNMbEZBWkM0emhuaUEwTGsvcWkySUJvUW45VDBQUE90ZnJLdU1lVjc1TEk3aTFVZUlVc1hNSW1lSXdVKwpzektHbTBCTnJVNDdoOWFYUCtxZVdwMTNUU05VdlV1UFN6UXZBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBRjArMDYxaStIVTVORmRUc3RhUTZGREgra3ZHRWttNHBSZ01iYzFXY2diWGpoTEdhZnBITDdWQU53OXMKcjI2dFh2UktRaDhDR21iQVM1ckJpM2VBMnRoRnNXb1RKQnNQU0dTa2VaM0pPNUNxcU12OFRyZ2xVcytYNFdaagpod2xuaXNtWFRDZm5JM1pjNUNaRUNUdDhFY2xML1RKMlR5MGpVTFBlTkhpWWxHZmJMOHpMN0RDVDFVTmo2L0h2CjZsLzJjNkhkYTRqYXZldElIN2JrNEtiUVpyM3haSWU3NUk3U0VmU0NyaDdQbm9KOEd0TGhiQzViMkdWOUNxck4KSkpYUENtbzhwN21CZ0pPUndwT1ZoRkRwSVZtd2ZMaEFpV09uSVlYcFJVbUhmdXZjbmJFZkxYb1REZlUraXJXMgpYb2ZRTGtlWUVBQ1NVTTBFWCs1d2IxYXN3OTA9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRRDVnTnhoTytRSHJEQU5CZ2txaGtpRzl3MEJBUVVGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd016RXpNREl5TnpJM1doY05NakF3TkRFeU1ESXlOekkzV2pBbQpNU1F3SWdZRFZRUUREQnRuWVhSbGQyRjVMWE5sY25acFkyVXVaR1ZtWVhWc2RDNXpkbU13Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUM0blpqZWVmZkVSZWw4MlBvdkpnc1kwazJaQ0pWa2F2dngKMWZWS0dGSW5tdnVaVUpKcjMxQmVaendydGM2WERSbUFuUHRuRW90S1JvMmoxQWV3MXNJWEpZaWVVWG5WS3NyOAovZ3UrRDF5VmdYUE1sb1NGcGo3OWhRVUcrUVNpaDZWSGZlKy9kRk15bTloemdnUFovN05XNHdGS3hLZ1dlVXRSCnRYME9oYUhyVU1Od28wWGYwbjVzMzV5NzhBanF2bitLTGV6UGVxV09HYTRyQVU5dzhVcmJwby9zcUM2cnZGUTgKOGpjbXQ4dUkzTElPV3F2eTRaU3k2Y21PeE12RGo1ZlBuS2xYdElMczVhZVpIV0gvNkpuWTJWV2FMQUtvbXJjcQpLUkJYRzBGdmYvTlpqaEdWazg3dCs0TU1ubWlUUStJeVIrT2s2aEFjcUpqUGViaEVFNGNkQWdNQkFBRXdEUVlKCktvWklodmNOQVFFRkJRQURnZ0VCQUpNbW5sa2tHOU9OWUZnYlkzalNheU44c1YzZDNiOXdrclhzVDk5TUtYRHkKclRSNE9IS3cvelVQSWhkc1lGdGdWWDFPb0I0eGJZT2VnVDd2VnIyZXEvTkRUS2NpVzE5NnBmWjNOME9qL1JrRgpaY0JpUmFXY2RZdlBPOW93bjZYb1NaRTNVeTJBdmxDQVh2WEtMTmhWN3NQNkhnSzIyUHJaZEg5b3BoaDJ4R1V3CkNpTitXVTBWUUZ5R2FRMUk3S2ZPOVRQN25lZXRZZEQyNjc0Z0JySFBMY0hLdlBTeU1NYTNPKzJQVHhUOTR2NU4KOWgwQW14TEFxK3FIaWNlT3FHd3Z0K1dJWlNJVk9NNFN4cmFScHlBRzZsOEhhZExiVzh0VGQrNTZ3RUFzd1NUcQpRcUZ5eFVWOVNWczErRnRvREV2ZjFSMVNkVDYvMi9FV0pJUEtEZTQwa1FFPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdUoyWTNubjN4RVhwZk5qNkx5WUxHTkpObVFpVlpHcjc4ZFgxU2hoU0o1cjdtVkNTCmE5OVFYbWM4SzdYT2x3MFpnSno3WnhLTFNrYU5vOVFIc05iQ0Z5V0lubEY1MVNySy9QNEx2ZzljbFlGenpKYUUKaGFZKy9ZVUZCdmtFb29lbFIzM3Z2M1JUTXB2WWM0SUQyZit6VnVNQlNzU29GbmxMVWJWOURvV2g2MUREY0tORgozOUorYk4rY3UvQUk2cjUvaWkzc3ozcWxqaG11S3dGUGNQRksyNmFQN0tndXE3eFVQUEkzSnJmTGlOeXlEbHFyCjh1R1VzdW5KanNUTHc0K1h6NXlwVjdTQzdPV25tUjFoLytpWjJObFZtaXdDcUpxM0tpa1FWeHRCYjMveldZNFIKbFpQTzdmdURESjVvazBQaU1rZmpwT29RSEtpWXozbTRSQk9ISFFJREFRQUJBb0lCQUNNTEJ6Rnp4V3drT1NYUgpxZXU1TlBJSk9XR0xGNUJ3SGxMUllqWW1WN0hjNFZWQXpncGI0VTJLR3duUkFOMzdScFA3T0YxZ1Q4QlJsQ0U4CjVoalRLeFJwczMwWnloNkVlUE44NVkyMkxNVFVSYjdYODEvTEpybkl2aU9Nc1N5SXd2N0hFUE11aVh4WnlNUmsKTVliMzJucnJyQnNkS1NyYTYwa2ZRaFczbC95cWpWYzNSS2VMRUNJdWpiblRlV2FOZzU5RC9iT09EUHJiYlhPYgpWaURFbkRmbGdBQ0g1SWdyNnVKd2w4MUNuNHdpbEJsUk5zdmkyRC9yQ1BpK09EdG5jbjYwQ1N5b2VZQUpMbzF1ClVtZkxxUGRyaExIOUt6NWhYajRVdFY1cWNKbGFRMHIrYnI1TmNoakl6ay9rZG53OGN2bGR5cXE0M2xiTmw2encKb1duMUJhRUNnWUVBNGNWWWtRaGFwNmhjN3VKVzZ2QW1ycFNncGJycWl5aGZMV2dNZEFFUG1WUzhXU25EOXU4ZApIMVhNNDMvdmVjSUVGNVlwai8wendZSkRzbEZRZlIvc0FxbEZFT0Iwd0VQSWN1QkUzdjhib25rek9MUkV4NGlGClNlU3Rxc09KTDFEbXBNSlFlbGwybHBtUzY5QlJpcnozTWc1SHhkdUs2M1NCejVneHk3bmdDbzhDZ1lFQTBWV1cKMmI1SkZ6SGFHWUttRG5aQXJwNGtKREFrd05IaDE5N3RhY0g1eXA5bzBROXlXcU1ZVDhWOVc1a1JleC9lQ0FoMgpsTEY5QW1IT1BnUFpzd2U5b3k1d2RRNVlmaW4yNEV1WWVWUWtzdEwyWGlTV3lLSmdQUXZNKzMyRG1vVWF4bjkvCmtsejBPQWx4SzQyU0MyemdOb1lhdEJWYnFnT2E0YkdZVENNQ21aTUNnWUVBZ1BVeVE1VmNBc3YrV1V6YmpOS2oKcGJDcm1qNkwzZlN2ZU1ZbjV0TDhULzdBbnNWbWM5UGM5SnNUcnhiU2VOL0RhcDJSRy9mcTZpczM4OURTZ3NZTApEdklVeXpFS1B3LzRuUFZSSVhiaUdBbldvaHNGOWxzYWx6eVJuaXFXWDNwOFk3dkNNRUNOcGpRT1liZlorNzg0CkMxVncxYWt6VG81NzMxSDFqNEthWUMwQ2dZRUFoNzNKYVA3VUpIOUdIeDZ5RVZTckV0QW5QWFFla1E1SU5aUXcKUFZEMGFtaStManFtKzVFZzFiR0pYVmsvbGFpUGNJUVVhTTFDODhWNldJcGtvNHdVYzNsTW9Rc2haUVpQT1JpcwpFWmozaHlIM2NncWw0QW95LzhMa00vd3ExNHNTVnI4Y2VVdGZiZXJwZ01WM2U0TXBUUkhleFFISWc5RjhvSGRwCis0MEVSWk1DZ1lBVEVLa0lqdVJwS3p0ZmNBaStObFE2ekhUQ0UraHJmM2xsVGhxbkJJWHBocyt3dGQ4WTYyYUcKT1dhcXU2dy9JbEMyRHRWYXFUM0VGUi9hZXM5cVlxRjhGZnhIaHNnc0R1N1ZyQytncXI5ZkhUemZVdjNlWlVjVQp5MHpXWVVhRjQvb3EvQS9KVTBuTWhCRTV6NkR2RVZESWs5dHI2bXJZQWY0bXJsU1pyYi96c1E9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: default
type: Opaque
