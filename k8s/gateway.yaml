##################################################
## Gateway Service
##################################################

apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: default
spec:
  ports:
    - name: http
      port: 5000
      targetPort: gateway-port
    - name: https
      port: 443
      targetPort: webhook-port
    # - name: admin
    #   port: 8080
    #   targetPort: admin-port
  selector:
    app: gateway
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-env-configmap
  namespace: default
data:
  APP_ENV: "production"
  ADDRESS: ":5000"

  WEBHOOK_ADDRESS: ":8443"
  WEBHOOK_KEY_DIR: "/run/secrets/tls/tls.key"
  WEBHOOK_CERT_DIR: "/run/secrets/tls/tls.crt"

  ACCOUNTS_ADDRESS: "api-accounts-v1-accountsservice.default.svc.cluster.local:5000"
  ACCOUNTS_TIMEOUT: "10"

  DISABLE_K8S_CLIENT: "false"
  ENABLE_STACKDRIVER: "false"

  PROTO_MAP: "proto/map.json"

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - name: gateway
          image: registry.gitlab.com/isaiahwong/cluster/gateway
          imagePullPolicy: IfNotPresent
          ports:
            - name: gateway-port
              containerPort: 5000
            - name: webhook-port
              containerPort: 8443
            # - name: admin-port
            #   containerPort: 8080

          envFrom:
            - configMapRef:
                name: gateway-env-configmap

          volumeMounts:
            - name: webhook-tls-certs
              mountPath: /run/secrets/tls
              readOnly: true

          livenessProbe:
            httpGet:
              path: /hz
              port: 5000
            initialDelaySeconds: 60
            periodSeconds: 120

      volumes:
        - name: webhook-tls-certs
          secret:
            secretName: webhook-server-tls

      imagePullSecrets:
        - name: gitlab-auth

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: default
---
# Role
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: default
  name: api-gateway
rules:
  - apiGroups: ['', 'extensions', 'apps']
    resources: ['services', 'namespaces']
    verbs: ['get', 'list']

---
# Role Binding
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: default
  name: api-gateway-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-gateway
subjects:
  - kind: ServiceAccount
    name: api-gateway
    namespace: default

---
##################################################
## Gateway Webhook
##################################################

apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: gateway-webhook
  namespace: default
webhooks:
  - name: gateway-service.default.svc
    clientConfig:
      service:
        name: gateway-service
        namespace: default
        path: '/admission'
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRREgra1dOdHBDMGlEQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFEwTWpBeldoY05NekF3TkRBeU1EUTBNakF6V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRQ3BhVVRaYlJmeXZYakZodnBkUytGWkVXWkhZZGFQeGZOdmlMQVNNeUNPV21oQjhWL1UKL1ZzWnBkeElkZjlFZG9BbXJMRzJhK3dCd2Z2Nk5XbG5EZ1kxUkNDaDZZdG5JdTNNK3EwVFFvbDNlUFdOUzJXaQpON0c2T2c5MmFKU0svMHZWbVZnTHZBdi9XbkFEY0RTRThqU0liQTRNSUVRVGxwcFgvYVZYdjByNmRIenlPY1hJCkE3ZzZheEpJWDhVVHU5TFlXeS9hVldESVNCQ0pKcFIwVzN1WVRPVU9GOGRsSzFmU2E0UHQvajZwMTFBdzhPVDkKM3pSaGZKTUJiRy81NGQxcWptMFZEWXFTbDdJTDZTdEhsbWNCamhSTndBektZQ2QrdHdWbVVkYXpPMGd1Q1Jibgp2a3dKSnUzT3dnM2krMGpKUXJYK3UxdVNmR044czlxdXp1R3JBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBQi9QT0xzakdHYzZHRFdyVlFsMUdpYldvSUQ0WmV1alRJWUQwU1lVMXdCcnRvS055aXZYVWx4UHZockoKeVJZZ0Rsa09CRGpWc3REUDVrSHhadkxscWlWSnZmd2xBT2tDaG1jNzNyZlJLZnJLQ09KY3JrRmp0dEllRmp4QQpTRUpVeEtybEd5TmJ3K25KTHFESVZPQzRwbTlvUEtybXB2SXJWT01TRlFXcUZhcG4za0ZZTTROalBNYjRINVQwCm5uWU51cGVmRTN1MllrZHllVUlWbUNtTy80OE9DbzhhSzNLcFpTT1p4SmwvaUhwWWhUUzFGYmpPRk5DelU2OFEKRkZ0NTJ2YmxmRnFETitFcWx6UVY5dlExSVF4bjZuc0tON1hFa2VqQklPZTBMb0lKNHF1Nm9VOWVabkFKWDlHWQpmY2haejByR2I3WXlaR05WVGpvdTU0QjNjT3M9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ['*']
        apiGroups: ['*']
        apiVersions: ['*']
        resources: ['services']

---
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRREgra1dOdHBDMGlEQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFEwTWpBeldoY05NekF3TkRBeU1EUTBNakF6V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRQ3BhVVRaYlJmeXZYakZodnBkUytGWkVXWkhZZGFQeGZOdmlMQVNNeUNPV21oQjhWL1UKL1ZzWnBkeElkZjlFZG9BbXJMRzJhK3dCd2Z2Nk5XbG5EZ1kxUkNDaDZZdG5JdTNNK3EwVFFvbDNlUFdOUzJXaQpON0c2T2c5MmFKU0svMHZWbVZnTHZBdi9XbkFEY0RTRThqU0liQTRNSUVRVGxwcFgvYVZYdjByNmRIenlPY1hJCkE3ZzZheEpJWDhVVHU5TFlXeS9hVldESVNCQ0pKcFIwVzN1WVRPVU9GOGRsSzFmU2E0UHQvajZwMTFBdzhPVDkKM3pSaGZKTUJiRy81NGQxcWptMFZEWXFTbDdJTDZTdEhsbWNCamhSTndBektZQ2QrdHdWbVVkYXpPMGd1Q1Jibgp2a3dKSnUzT3dnM2krMGpKUXJYK3UxdVNmR044czlxdXp1R3JBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBQi9QT0xzakdHYzZHRFdyVlFsMUdpYldvSUQ0WmV1alRJWUQwU1lVMXdCcnRvS055aXZYVWx4UHZockoKeVJZZ0Rsa09CRGpWc3REUDVrSHhadkxscWlWSnZmd2xBT2tDaG1jNzNyZlJLZnJLQ09KY3JrRmp0dEllRmp4QQpTRUpVeEtybEd5TmJ3K25KTHFESVZPQzRwbTlvUEtybXB2SXJWT01TRlFXcUZhcG4za0ZZTTROalBNYjRINVQwCm5uWU51cGVmRTN1MllrZHllVUlWbUNtTy80OE9DbzhhSzNLcFpTT1p4SmwvaUhwWWhUUzFGYmpPRk5DelU2OFEKRkZ0NTJ2YmxmRnFETitFcWx6UVY5dlExSVF4bjZuc0tON1hFa2VqQklPZTBMb0lKNHF1Nm9VOWVabkFKWDlHWQpmY2haejByR2I3WXlaR05WVGpvdTU0QjNjT3M9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRRDJ6dGlmVjVRZWNUQU5CZ2txaGtpRzl3MEJBUVVGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFEwTWpBeldoY05NakF3TlRBME1EUTBNakF6V2pBbQpNU1F3SWdZRFZRUUREQnRuWVhSbGQyRjVMWE5sY25acFkyVXVaR1ZtWVhWc2RDNXpkbU13Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUURDZWZvOWpxaFF6T0RRM0lETDZ6dUFSVUd1ZUlrOFFaL2gKOFNwYnFicEZSbTVrQ3dIYzhlVGF1NGNIaEtkNUNtNWEzZHdSb1ppa2gzbEVURHo0MGlKMEtkaGpRanN1ZUNZdgpWS1JYRTQ2b2NEdUJMbTdUYU1sV01pUEo1VGcvQWtlVEhwS0cvVE4rcjRNb0hkakwraTBnSTBPODBrbkcxWHg4CjA2aDUzazNzVEU5a2F0RTNMVG1nRmtGUkZnM1ZkcEpzK3VqQWprTFBRWWN1T0M2di84MWh3S2tqUE9hTUs1Z1MKbnRRQ0Zabm5MNVBoWkNrYTJKeTZmanI1WEhnMDE4WUJ3Ym5LS3k0S1J2NytiUDR0V0NtSW9MVlliZ1Bsb0Z3WgpNVExUaitTdFEvUTNZRmZlek5iY3dyNGQ1WW1hWG9uZ0llNFB2RDFKN0JtWDluN01ZNW1CQWdNQkFBRXdEUVlKCktvWklodmNOQVFFRkJRQURnZ0VCQUZaK0tkQVpNSUR4RjBIS2ZrQktTUk5ZQ1dKQStvWitsblM2aGRTOXZ2dHIKZTdwMkoyUjBNWHgwMm5EcWROV0ttdVkyU2h4NDA4dFBxc05VdGl3Z2hRQnZ3eGV0ZG9STS80UWRpK1ZHZW5HMApQZFE2a25TYW1PbUk0RVcyOEUvL2JPNVIydEd3OEEraFhnbFhiR2tUbXBQSmdmV0preXczc0Q4cFVqM084RXlOCmZQbyttNzN5ZWhxaitjL1JLL3YwOUdsa0NvTXNSb1JRZGNuOXU4cFNOZTlwLzhtemF3WjByZ040dkJoWmpoYUMKR0pjN2NnbHZFVlhDSklUMUtXcGFKM3FSNk1ZUjloSVhJcDdlYXV0NlVHeUkrZUpIemdOM2J4UEloRlhINmpTbApUejJDSzhJVlBjTXUwSmI2bDR5aFZBbXdLclZlRm5vVDI5eTh3V1V4dWM0PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBd25uNlBZNm9VTXpnME55QXkrczdnRVZCcm5pSlBFR2Y0ZkVxVzZtNlJVWnVaQXNCCjNQSGsycnVIQjRTbmVRcHVXdDNjRWFHWXBJZDVSRXc4K05JaWRDbllZMEk3TG5nbUwxU2tWeE9PcUhBN2dTNXUKMDJqSlZqSWp5ZVU0UHdKSGt4NlNodjB6ZnErREtCM1l5L290SUNORHZOSkp4dFY4Zk5Pb2VkNU43RXhQWkdyUgpOeTA1b0JaQlVSWU4xWGFTYlByb3dJNUN6MEdITGpndXIvL05ZY0NwSXp6bWpDdVlFcDdVQWhXWjV5K1Q0V1FwCkd0aWN1bjQ2K1Z4NE5OZkdBY0c1eWlzdUNrYisvbXorTFZncGlLQzFXRzRENWFCY0dURXkwNC9rclVQME4yQlgKM3N6VzNNSytIZVdKbWw2SjRDSHVEN3c5U2V3WmwvWit6R09aZ1FJREFRQUJBb0lCQUhYd0F4SFJzY0ZPZmdncgpzTy81ZDl3U0pBTHFsazgwZlFGSWY2ZVhCcDk4VnZYVXR3eUdwWU1BdHFLWWovZVhtOVQvTnJaNmlWYzkwUXphCkx4KzJUNjZpc2RlQUV1UGJlVXk2eCs4R3JUejQweDFFUzNGcDJxK3JPSWozdVdSOHZXczYzeUY5Ni95bjg2SWcKZDVrNzNxSGV3UFdCa2J4RE8zdDM0SFFIbkxudmZvN0JwWFgzeFdJNEZXTElsTHlCNzRFblEyaHhadkhJVjFUbwppWXdUbEI5UTQxbWFGWDM4RUpqYWdJRnMvaCtyblZNOWhlNVhpb3FhUEJqdStPc2NzLzB4MWllM2JsVWJEQ1pICmJMRkpyTjAzUWJVSmVNNngyR1poelhhNXdWZjQzclBXUkpNWldEMDFiQ2xYM0h0Rkx2SkZ2MlJjUkhJQlRseGoKN0NxSzNBRUNnWUVBNGlTUTkxNmFHd1J3ODdwaVEzQklITmo2SDF3Mm14OTFib3cyR2ZWVksvYVMxbnRUZVdmeQpHSXJReDA0RGFsSE5KM0pBUEVPMXpURTU5TG1wTEZrYmZYWC94WDhGNVBtODVHSGFrL1hrVEZIa1A4NGRFWUt5CnM5RUE3Tnhua2dhTGhvb3Y2NlJrZ0h6R3ZrYkhuWDdIZWQrOWpnbUtGVWVVeWErbGpaVUx3OFVDZ1lFQTNDY2QKaUxCbU55ekZHWGs5aUdlQ1JiMFVpM1I5NU9JeXIxTGI5WGp1MnMzZ3Q1WXp2UFh3MmEwS2ZEMTNMK29KWmtJSQpqaWUrcnIvYmhkRHhiZWYybnZMOFhoTCtaSnFVTWhuRUxHMkVrbGtocTZ1aXI5eERrRGRTK3NlMEgydGxOMktsCklwVlJ6Q0U4ZEU0NlZFZmxIYWtTQlE5L3puWWttcjViTVc2a0RvMENnWUVBcDk1dkFrSG1jWkhOYXc5N2JBWkkKY2FtYm1uWHdUeHgrSnE3TVpsNlllQWNVbjBSekJaZGt2bFVsZ0Ixb0taOUpoRE9xZlZIaC9jekI4ZWwwTEdpRgpJSS9jYXJYTklWbEZuOThIeTNmbm5jUFloSWl6U1ZGVTZHaUlvRXRJVXJ5ckRCYytWVlQyQ2U4VjlSOURoS1VjCjNGcDdNcG5nTjhXb0xFTkh5SjdRV2VVQ2dZQXhwakNtN3dGZVdCNXJURWh3UnNlK2FwSURrVllERkhCUjBlSUIKVGpDdjc5WktFUG5DRjhVbGtqelhJQldOSEw3WjdQSjQvTVdvSzJTYW5UQ1ZsTWF0dWlib0lHaDJ6OVcwSnROegpJWS9RWVlHU2NiYlM2bDNpWEZlK2J1TlVZcWdGQVo0MFduQ0VGTXJKZ0Fydmp2ZEE1U3hITCtPbThFWDVFQTBJCjdPYmEwUUtCZ1FDYVFHU3pHVDJyZDVUTEtjWEw4U3dDaFdqMDAvMDBld1gvVHAxdXVqMHM2bE9QbjVIMmpBWGUKcjFFWmptRktnSk44OHJUTnlJTEU5OGROd0dwTG5xVlY2OFdXNk1NeWV4ZW9jaUk2TnAzZTVRMnUxZ2M4ZFk1egp0eUlrMXJZNnFReWc2aDNQOXF3Nm91Y0R3ZUppeXUyNG5qSVQzQUVCZnRhUzVxSTRxZWgzcWc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: default
type: Opaque
