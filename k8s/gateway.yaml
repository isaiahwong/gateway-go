##################################################
## Gateway Service
##################################################

apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: default
spec:
  ports:
    - name: http
      port: 5000
      targetPort: gateway-port
    - name: https
      port: 443
      targetPort: webhook-port
    # - name: admin
    #   port: 8080
    #   targetPort: admin-port
  selector:
    app: gateway
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-env-configmap
  namespace: default
data:
  APP_ENV: "development"
  ADDRESS: ":5000"

  WEBHOOK_ADDRESS: ":8443"
  WEBHOOK_KEY_DIR: "/run/secrets/tls/tls.key"
  WEBHOOK_CERT_DIR: "/run/secrets/tls/tls.crt"

  ACCOUNTS_ADDRESS: "api-accounts-v1-accountsservice.default.svc.cluster.local:5000"
  ACCOUNTS_TIMEOUT: "10"

  DISABLE_K8S_CLIENT: "false"
  ENABLE_STACKDRIVER: "false"

  PROTO_MAP: "proto/map.json"

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - name: gateway
          image: registry.gitlab.com/canderlabs/gateway-go
          imagePullPolicy: IfNotPresent
          ports:
            - name: gateway-port
              containerPort: 5000
            - name: webhook-port
              containerPort: 8443
            # - name: admin-port
            #   containerPort: 8080

          envFrom:
            - configMapRef:
                name: gateway-env-configmap

          volumeMounts:
            - name: webhook-tls-certs
              mountPath: /run/secrets/tls
              readOnly: true

          livenessProbe:
            httpGet:
              path: /hz
              port: 5000
            initialDelaySeconds: 60
            periodSeconds: 120

      volumes:
        - name: webhook-tls-certs
          secret:
            secretName: webhook-server-tls

      imagePullSecrets:
        - name: gitlab-auth

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: default
---
# Role
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: default
  name: api-gateway
rules:
  - apiGroups: ['', 'extensions', 'apps']
    resources: ['services', 'namespaces']
    verbs: ['get', 'list']

---
# Role Binding
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: default
  name: api-gateway-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-gateway
subjects:
  - kind: ServiceAccount
    name: api-gateway
    namespace: default

---
##################################################
## Gateway Webhook
##################################################

apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: gateway-webhook
  namespace: default
webhooks:
  - name: gateway-service.default.svc
    clientConfig:
      service:
        name: gateway-service
        namespace: default
        path: '/admission'
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRRDJSelh4SVNIT2pEQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFkxT0RJd1doY05NekF3TkRBeU1EWTFPREl3V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRREVDUlhrdkpreTVJK0ZsdGlpdGNoRkFycFkzZkV6WTZsakIwZ2h0RVE5U0pJUWV2MlQKMktTRXBBOHJrUmZyaVQ0MFp0S0VJNng2MlhCWG1vVVl6TVhvQW1aNlFHU2JhbkJrdzZoVkhrejhaRFdsbmRKTApBRndOdkphTmttZE5oOERjbUZxMGtDTGxuZ0RPOEwrei9xLzA3dTVyNzRrZVB6SUcwOHkwUHFvbEVaSHlGZ3JLCjBsTVRvSnpPMG5LWVh6Z011VHVxYUprcVR0QjdHMTArb09Jc0I3MW04QWdaQWJESTFDK2ovNlpEQlI1L1FpWTcKQzJyZ2NtZ3MwaXkxUXBJSTFOT0dTTGFzQmRhNlZqN0JEellKSzNJQzFKWUtTR1VVT1l0TzQ2QXZlV08xUjZhNwprSXJyb0ozZTJnZG9CYkNucTJCLzFSRmxVenFsQzIrZEZWZkZBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBSGFmS0JrNFhia2c3R3U0Q1hiQUZGUGZoVXpZK29PdzVrTUxHczBEL3R0ak1FL3J2Uk1mTUhWcWlhTjQKczJmZ1VCTXdGUkluVXp6MEd4VVN6bWU3QUtJdzRXU0ZCR2dBQWxFZnZCUWtWZWxWOW1JbmF3SWU1aVpNazYwVgpBRXY4WkFRVG0wSGFMbC9OQWFVNzZXcUx3dnNYVHBkaDFnVi9CVHNuM2JoZmd4M0hHWk82UzJadXp6SkFuRlF6Cmo3UEJUTE0rclJOdVdmRjZaeHlyVHlKb3FPOTJpS1llN3EwSUdVNXIxaEJkRXJOWEZLY1d4dE5VWGM2M2IrZ2IKZi9ta1B1em9CMVcrbWpUdHBDL0JWcVg0cnlvOUEyZGRSaGl3UDJQa3pHaXBoN0F1dmNnMWNUR0lzRlRkbk84WApnci9Zc0JiVVlrZmpyTW5rWHVIOE5HWG1teXc9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ['*']
        apiGroups: ['*']
        apiVersions: ['*']
        resources: ['services']

---
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRRDJSelh4SVNIT2pEQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFkxT0RJd1doY05NekF3TkRBeU1EWTFPREl3V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRREVDUlhrdkpreTVJK0ZsdGlpdGNoRkFycFkzZkV6WTZsakIwZ2h0RVE5U0pJUWV2MlQKMktTRXBBOHJrUmZyaVQ0MFp0S0VJNng2MlhCWG1vVVl6TVhvQW1aNlFHU2JhbkJrdzZoVkhrejhaRFdsbmRKTApBRndOdkphTmttZE5oOERjbUZxMGtDTGxuZ0RPOEwrei9xLzA3dTVyNzRrZVB6SUcwOHkwUHFvbEVaSHlGZ3JLCjBsTVRvSnpPMG5LWVh6Z011VHVxYUprcVR0QjdHMTArb09Jc0I3MW04QWdaQWJESTFDK2ovNlpEQlI1L1FpWTcKQzJyZ2NtZ3MwaXkxUXBJSTFOT0dTTGFzQmRhNlZqN0JEellKSzNJQzFKWUtTR1VVT1l0TzQ2QXZlV08xUjZhNwprSXJyb0ozZTJnZG9CYkNucTJCLzFSRmxVenFsQzIrZEZWZkZBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBSGFmS0JrNFhia2c3R3U0Q1hiQUZGUGZoVXpZK29PdzVrTUxHczBEL3R0ak1FL3J2Uk1mTUhWcWlhTjQKczJmZ1VCTXdGUkluVXp6MEd4VVN6bWU3QUtJdzRXU0ZCR2dBQWxFZnZCUWtWZWxWOW1JbmF3SWU1aVpNazYwVgpBRXY4WkFRVG0wSGFMbC9OQWFVNzZXcUx3dnNYVHBkaDFnVi9CVHNuM2JoZmd4M0hHWk82UzJadXp6SkFuRlF6Cmo3UEJUTE0rclJOdVdmRjZaeHlyVHlKb3FPOTJpS1llN3EwSUdVNXIxaEJkRXJOWEZLY1d4dE5VWGM2M2IrZ2IKZi9ta1B1em9CMVcrbWpUdHBDL0JWcVg0cnlvOUEyZGRSaGl3UDJQa3pHaXBoN0F1dmNnMWNUR0lzRlRkbk84WApnci9Zc0JiVVlrZmpyTW5rWHVIOE5HWG1teXc9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRQ1BMZEFRYUNTS1JqQU5CZ2txaGtpRzl3MEJBUVVGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd05EQTBNRFkxT0RJd1doY05NakF3TlRBME1EWTFPREl3V2pBbQpNU1F3SWdZRFZRUUREQnRuWVhSbGQyRjVMWE5sY25acFkyVXVaR1ZtWVhWc2RDNXpkbU13Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUNxWFZZa2U3SHkwMExBdHFEcElLQ3BFaW5ydTZ5azBHNWwKUzE5R3BXdkhFdmFkdXpzdkF5NmZVdk5KTE8rK2RER2xpOEs0WHg4VnJyYTdJTmtKMnlFUHA3enpoM2Q3VWhQcwpNZVVYNmRQTFZ2cXVXRHh0ME9CSG0rdnplQXpZVE9pMTdONXQzTjdjRnpzY0pMcXVibndncGhIV3Y3ZS8zajRSClBxOHZ0RnYrcnV3Q3Vwc2xwYVNKTzUrbXRrMWxmOG0renR3Wkx1dXdXeHpTeWNieXNES1lwNEE5V0VjWTJVM2wKaEYwQ3paMGxBQ1h0ckFDSi9HME0wc3dvRndSdmVBRndkYmlLbzhKdUlJeDdCbXh5a1g2eUxKL1hBR0FCMkRncApURGZTR0FBZDFlYWhQWndNcjNzd0N0OWM4dHVrWDBWanBFdm1OTnhra1MwZnZibzdFK1d4QWdNQkFBRXdEUVlKCktvWklodmNOQVFFRkJRQURnZ0VCQUlrMGI5MjV1Wkx4SXhTRFM3YUZ3cGhPWUdOSVozVWRtb2tuWDNPR2d0NzMKMmhlUlhTVVBFYjNVN3BmR0ZabVBlRUhvSS9ockdRamVMTjJxeHlJSzBOUkdrMHpLTmgzZGlRemdXUEl3UlFmaQpvdVBGRVM1OXJUY2FYcHV3RjYxRm1aMDlIQ2F3c2ZrUTcvRnROT1hIUk5ZWTQ3YzRrUVFOcG8zMlFGTDZ6VVFTCmxWMkNLQTAxZXRqODRMVUNmcUhrS0pjcUZLY0VuQVdUaHF2Rk84bmtDKzhCNlJMSFVSSTVYRHFLL29HZWdsSTIKSkJVU1ZJVHJ1Y2N0OVg3OWh4UjJVb0V6enhKNFV1QjI0TXFnOVQxR3UvZkdjdmpka3ZzczJkeWwzQlhXU3RVRQo1TzZ1YlB4MkZGK2hBcUdWWmZJMXhMQkNyYkUyYnBsWXN6VHptamRJUUk4PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBcWwxV0pIdXg4dE5Dd0xhZzZTQ2dxUklwNjd1c3BOQnVaVXRmUnFWcnh4TDJuYnM3Ckx3TXVuMUx6U1N6dnZuUXhwWXZDdUY4ZkZhNjJ1eURaQ2RzaEQ2ZTg4NGQzZTFJVDdESGxGK25UeTFiNnJsZzgKYmREZ1I1dnI4M2dNMkV6b3RlemViZHplM0JjN0hDUzZybTU4SUtZUjFyKzN2OTQrRVQ2dkw3UmIvcTdzQXJxYgpKYVdraVR1ZnByWk5aWC9KdnM3Y0dTN3JzRnNjMHNuRzhyQXltS2VBUFZoSEdObE41WVJkQXMyZEpRQWw3YXdBCmlmeHRETkxNS0JjRWIzZ0JjSFc0aXFQQ2JpQ01ld1pzY3BGK3NpeWYxd0JnQWRnNEtVdzMwaGdBSGRYbW9UMmMKREs5N01BcmZYUExicEY5Rlk2Ukw1alRjWkpFdEg3MjZPeFBsc1FJREFRQUJBb0lCQUQzNjlSTVMyWHV4ZG5DcwpRTUJ2K1dOcFUwMExHMVZlNnpyNC8vR3d6eFEvQnUvOXBSdUdlZGpIRWZIR1luYVV5VmNrRUxTSkRzTVJyRE5LClVRdnY2QWhOQzBaQ082cm5BbzZFM0ljbHI4TWpvdEg1RWdzVjJmTFRmRFU0c051a3AybEFndS9QVWxrYUxvd2YKcExjL1JQT1AxNStjWWxwd25YNGlveE9rOTI4aFZwQ0dxeWRFQ1VpNzZvN09Teis3d1lyTTJUSTdBNU5kMFE4MApUV2FBaGxNRnFXcUFSbmJMTXYwT0ZFTDBPWGU2OWt1ZE11ZGs5MHNNVy9HdVBaZklVc3dEdElYWnJVL05kTDhIClhjaFVpUWRUeDA4NlRLYVRFL0hJd2J5T1hYSnR0eGJaaHJQYThCSHlscTh6MUxzd3hxNWJleDZNQmZMQmkzTzIKMTFHS2dPMENnWUVBMGN5d2hjWVZ4WCtmNnAxRzVhbGFlOHN5Q1FMTklidDNUMG5ZS1J3Rmpac2RYamZXbDVrYwpQUG5TOHZNUGF5U3pCN283RE5KSjlwOEx5bDUwZFBMTGtFUkxaR1EzaFozOXFISEJSclQxdmNNUnE3TVg0MENpClgraVlrNXVTVUt1akFjSllqTVQyVHV0cURWYmNmRkJ0a1Q0WW5jYUdPMTFiWWxDTTJURlZENWNDZ1lFQXorR0cKMXNuZ2ROK2RNa3ZyYi9XSXo2aCtOclFkbHhUQXRjamcwVXE0K3VsMk0xUGc2VmxDMXVyTkZ6UlcvNWVHb3FKcwpYSjhacTBsVVRnSXNiaDNRWDAxOHdBb053d1RwSVkydjZBOTJrV0c1UzNFa2xVUzRCaTBMc0hCZkhrdk5TUDg2ClMwWWQzVW5rbUg5b3ErUjlXV2hjRVUrY012enQrMGlmUm9wb1hmY0NnWUFjOVZud1BSVklPNE9CU05BK1p3L2MKUW9IWGlKRno5SUpWYVdYeTFyRlZpSEdYVGJITEh4RXN3WGNDbmRZay9kM1FWVDVOV01Gb3p5ODdjYW8xY2tYeQoxZHBxTXdNTzZHM1kwRXJUVGFzVjFGVWVGQXhhQzlQZDFTY3FTTEQ3ZlpWMGFyVDZTVDJPU3lSS1R4RUQvNzMvCjdFaE5qdGQ4WGpoODY0MWxkVSsrWlFLQmdRQzFqMXpzUlo5VGxHWkFJb3k3MlRBblpocnQvandGMHl0STJleDQKL3hFMm5DY1BSMGdkcGtjNVhCUEtHMzJNZURRdjRUcFJYdWZWY1JNL21xaGhlSXFnWWhYOXlBb2k5U3dFa1RJOAp0Unl5ZHk2VjFIakdJaUd6eXkzMWFQKzZmeXdKZ0ZqU202ZkR1U0Q5aS9ISWg2UnZMVFdVTFByWWtZM3N0WTNlCjEwMjJHd0tCZ0hnbUQybGh6NFRUNFVLcXFWQzFSdDdlcDBzZnZJblBZQjJZdG5ldVFmK05NbG9VSytCRnU0SDUKNmx5bmpvTHpMejVqK3R3WGhDSDgyakw3K3FtcmNiTURQWHRmSlArMzhxbm85Vk1xTGMyR3JaWnpjSjg2K2MwZwo3TEZObXBjOXVaYU1PcTQ4RkpkQkt4V3QrcVFnQkw0aVltVzlObVA5QVlhTDZPak5PTndFCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: default
type: Opaque
