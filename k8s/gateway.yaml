##################################################
## Gateway Service
##################################################

apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: default
spec:
  ports:
    - name: http
      port: 5000
      targetPort: gateway-port
    - name: https
      port: 443
      targetPort: webhook-port
    # - name: admin
    #   port: 8080
    #   targetPort: admin-port
  selector:
    app: gateway
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-env-configmap
  namespace: default
data:
  APP_ENV: "development"
  ADDRESS: ":5000"

  WEBHOOK_ADDRESS: ":8443"
  WEBHOOK_KEY_DIR: "/run/secrets/tls/tls.key"
  WEBHOOK_CERT_DIR: "/run/secrets/tls/tls.crt"

  ACCOUNTS_DISABLE: "true"
  ACCOUNTS_ADDRESS: "api-accounts-v1-accountsservice.default.svc.cluster.local:5000"
  ACCOUNTS_TIMEOUT: "10"

  DISABLE_K8S_CLIENT: "false"
  ENABLE_STACKDRIVER: "false"

  PROTO_MAP: "api/map.json"

  # Redis
  REDIS_ADDR: 'redis-gateway.redis-gateway-service:6379'

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - name: gateway
          image: registry.gitlab.com/eco_system/gateway
          imagePullPolicy: IfNotPresent
          ports:
            - name: gateway-port
              containerPort: 5000
            - name: webhook-port
              containerPort: 8443
            # - name: admin-port
            #   containerPort: 8080

          envFrom:
            - configMapRef:
                name: gateway-env-configmap
#            - secretRef:
#                name: gateway-env-secrets
          volumeMounts:
            - name: webhook-tls-certs
              mountPath: /run/secrets/tls
              readOnly: true

          livenessProbe:
            httpGet:
              path: /hz
              port: 5000
            initialDelaySeconds: 60
            periodSeconds: 120

      volumes:
        - name: webhook-tls-certs
          secret:
            secretName: webhook-server-tls

      imagePullSecrets:
        - name: gitlab-auth

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: default
---
# Role
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: default
  name: api-gateway
rules:
  - apiGroups: ['', 'extensions', 'apps']
    resources: ['services', 'namespaces']
    verbs: ['get', 'list']

---
# Role Binding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  namespace: default
  name: api-gateway-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-gateway
subjects:
  - kind: ServiceAccount
    name: api-gateway
    namespace: default

---
##################################################
## Gateway Webhook
##################################################

apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: gateway-webhook
  namespace: default
webhooks:
  - name: gateway-service.default.svc
    clientConfig:
      service:
        name: gateway-service
        namespace: default
        path: '/admission'
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRRG0wcmxIbkdEMWdUQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpFd056SXlNVFF6TVRFNFdoY05NekV3TnpJd01UUXpNVEU0V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRQy9saXFDelNGQU9sSTRIKzVaTU9pWkQ2Y3U3K1IvMit4Y3BHVnBFM1FFR3FwM2FxZkcKSnhqVFRGckErNjNSd2cvUndKSm00S2hMQ2U5T1dLcTQ3NDZWU2tudDRCNE4vQ1k0R3Z6eG5odWxNdnV2L0s1RgppQUU5MkM0bUNtMVRlQnpCVitYNU9hdUhudWZPbHpTTVA0UmZyTHZVSEtwNXBYNC9pWWhOYjlwcVBkRlA0SnAwCitzZWw2bHpoSmhCUUg1aWFYMnFMSUVlUDdJVFVTdEN0S3VEbmJSdlBNRno1RmxTMm1JRTFTUzBCTUpocUVVYnQKQTJzbjZCRkNBbUMxZjI1alhaL2lXYmZPY253S29KOVF5aG9pb3k3REdXTFRMbzVlN0RUU2thL014dGRaL2VpTAoyVHVDV2p3Y0UrbWU4ekZFY0hHVzRaWC9HcTdlelU5QWdNVnRBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBRG9qaXZaVi9oMnViWXk2NU1Sa3k3N3dyTXZ5K3BlbE5xRU9rb0prVFJwQ1QzK05iN1RVRk9qNDJFT1MKYndCbE1TaWt6K1MvQ255K1RuR1NJZ211dHV2bi9TN0JLVjAyVlRITlpFL1FzZ3FFMk4yaTI3N1BMT2FhWEozUApzWnNhVFk3MEVDemIyeklHTFE0RjYxMjhYc2VtdTVOUlRnQ2J4M3YzV2JvaHVLN2ZIUXZ6SlFnMkZKRjcxSE8vCnFPTjR2OHFSc0N0VElOa1lMSjVrby9MOWVhdWpvSlNrSFBxOFB4VnMzOS93d0tjcklrSUZIelA2T3UrdjdiM0wKL2F3QkhKLzVuZG9tQTJ1bEhLbEh5VWNGZzVlYWpWQnJWb2podVh3OGcvenZOM0pkaHlBWTUvKzNkZlNxT0NZRgozN1hYSC90Y1QxY2gxVUo1S3hyQ0tkOFZEOGM9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ['*']
        apiGroups: ['*']
        apiVersions: ['*']
        resources: ['services']
    admissionReviewVersions: [ "v1", "v1beta1" ]
    sideEffects: None

---
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRRG0wcmxIbkdEMWdUQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpFd056SXlNVFF6TVRFNFdoY05NekV3TnpJd01UUXpNVEU0V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRQy9saXFDelNGQU9sSTRIKzVaTU9pWkQ2Y3U3K1IvMit4Y3BHVnBFM1FFR3FwM2FxZkcKSnhqVFRGckErNjNSd2cvUndKSm00S2hMQ2U5T1dLcTQ3NDZWU2tudDRCNE4vQ1k0R3Z6eG5odWxNdnV2L0s1RgppQUU5MkM0bUNtMVRlQnpCVitYNU9hdUhudWZPbHpTTVA0UmZyTHZVSEtwNXBYNC9pWWhOYjlwcVBkRlA0SnAwCitzZWw2bHpoSmhCUUg1aWFYMnFMSUVlUDdJVFVTdEN0S3VEbmJSdlBNRno1RmxTMm1JRTFTUzBCTUpocUVVYnQKQTJzbjZCRkNBbUMxZjI1alhaL2lXYmZPY253S29KOVF5aG9pb3k3REdXTFRMbzVlN0RUU2thL014dGRaL2VpTAoyVHVDV2p3Y0UrbWU4ekZFY0hHVzRaWC9HcTdlelU5QWdNVnRBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBRG9qaXZaVi9oMnViWXk2NU1Sa3k3N3dyTXZ5K3BlbE5xRU9rb0prVFJwQ1QzK05iN1RVRk9qNDJFT1MKYndCbE1TaWt6K1MvQ255K1RuR1NJZ211dHV2bi9TN0JLVjAyVlRITlpFL1FzZ3FFMk4yaTI3N1BMT2FhWEozUApzWnNhVFk3MEVDemIyeklHTFE0RjYxMjhYc2VtdTVOUlRnQ2J4M3YzV2JvaHVLN2ZIUXZ6SlFnMkZKRjcxSE8vCnFPTjR2OHFSc0N0VElOa1lMSjVrby9MOWVhdWpvSlNrSFBxOFB4VnMzOS93d0tjcklrSUZIelA2T3UrdjdiM0wKL2F3QkhKLzVuZG9tQTJ1bEhLbEh5VWNGZzVlYWpWQnJWb2podVh3OGcvenZOM0pkaHlBWTUvKzNkZlNxT0NZRgozN1hYSC90Y1QxY2gxVUo1S3hyQ0tkOFZEOGM9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM3VENDQWRXZ0F3SUJBZ0lKQUttRGF4QVRmN0ZETUEwR0NTcUdTSWIzRFFFQkJRVUFNQm94R0RBV0JnTlYKQkFvTUQyZGhkR1YzWVhrdGMyVnlkbWxqWlRBZUZ3MHlNVEEzTWpJeE5ETXhNVGhhRncweU1UQTRNakV4TkRNeApNVGhhTUNZeEpEQWlCZ05WQkFNTUcyZGhkR1YzWVhrdGMyVnlkbWxqWlM1a1pXWmhkV3gwTG5OMll6Q0NBU0l3CkRRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFMZlVDRlp0dWF4eWdpZU0wTWtVSGFyYnJBZFUKRy9iSnh1TXpuTG54MmZIaUU5blFWYlNlbDlrbnoyUkFrakl6Ri9HcEhMeXMvM1BpZjJvQk1qajhDWnpReVZkMQp6ZVBNQnNaRWJNdnFtKzVOOVhMUUhIKzVyaE9FYzZzbmlPcmx5Nk5RUm85WWRTQk51Nk1mQnVpbjFRaS84NGhMCkhrMVZzbHRsNjNqM21adFFKSk45SEUreXZ3b1BjK0dQdkZlci85NVVtei9YdWVIeGFVWXNWNWZieUQvYUxrUksKVjBNWkNuN09pZlhzL3dNR1ppTUwrSmZudXc1RXkwWkIrVHloSkRCbjJSOWphdTNYSmtJeCtPa2FSMnQvVU0xMQpXUTF0Mk1IN2J3MkxDcmJ3ejMxcTQrTG93cW42cS9JdUpmR1d4dVBPTTd2TUxaUi9iWHJyTVpQRmhJRUNBd0VBCkFhTXFNQ2d3SmdZRFZSMFJCQjh3SFlJYloyRjBaWGRoZVMxelpYSjJhV05sTG1SbFptRjFiSFF1YzNaak1BMEcKQ1NxR1NJYjNEUUVCQlFVQUE0SUJBUUJqUmFXTDhmcDMzZ3c2RnFacVppblRHbVNEcUNuelVQMW1UbXNaS1ZaQwpHZFF5N0k2TUZ1N2lrVHptTlJEWVZQdTBlRjRMK0J2QkZIT3l5ZmtBTkNYYjNTL2FzNm5OaGd1Mkd3cjhXM1VmCllhMUVEbXVzc3I5QVEwNWNUT2FuYkxaNXU3dDh5NmdaaVlrZ3pYdEdaVGJ2dWpycVlKVmVzazIycmFBNmdsWEEKZ0lod3Exa2hEKzlMcGVaRnpDWm0wZFZrT0lXdCtORkJjeWE1SThWOFh3c1pmbHAxSHFaUHFUY24rQUkzYW1hcApNeFkrMXhmVXRZL3ZoMTUrMFdYdDZKZkFyeU5hdWNZK21VR1VlbElYcTcyTVlReVo2YTVaNlJDZXZWOWJ1cDFNCnI3UVdzRXJVZjFRNGQzSmVCUzgyTldPNm52KzluSFFaYXBwWDlRVk9QZEtGCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdDlRSVZtMjVySEtDSjR6UXlSUWRxdHVzQjFRYjlzbkc0ek9jdWZIWjhlSVQyZEJWCnRKNlgyU2ZQWkVDU01qTVg4YWtjdkt6L2MrSi9hZ0V5T1B3Sm5OREpWM1hONDh3R3hrUnN5K3FiN2szMWN0QWMKZjdtdUU0UnpxeWVJNnVYTG8xQkdqMWgxSUUyN294OEc2S2ZWQ0wvemlFc2VUVld5VzJYcmVQZVptMUFrazMwYwpUN0svQ2c5ejRZKzhWNnYvM2xTYlA5ZTU0ZkZwUml4WGw5dklQOW91UkVwWFF4a0tmczZKOWV6L0F3Wm1Jd3Y0CmwrZTdEa1RMUmtINVBLRWtNR2ZaSDJOcTdkY21Rakg0NlJwSGEzOVF6WFZaRFczWXdmdHZEWXNLdHZEUGZXcmoKNHVqQ3FmcXI4aTRsOFpiRzQ4NHp1OHd0bEg5dGV1c3hrOFdFZ1FJREFRQUJBb0lCQVFDRHBjK0t4ZTNRdC9qSwpCaWlIdUdZK3RDOFEySVZtU2I2cmU0emtCWFlGcWRoNWhwKzZTRkdLN04yemVDSzYzS2hySXFjMzM5VFowdjFZCmx4NjJmSmtOdXVCV1NFRjR2K2FpR3VLbmJvN1pMTzk0bDkyeEF2TE5lMit5eFE5aTJjcnFYRlVMMTFlYUdORWwKMHRTSnpaZmRPa3BYOHlQeVVrcjI5WmlhK3djQW1ENUg5QVQrUVVZVDJERjJ4MkxNVVNiaXV3a1RXSGNsTGtnSgpCeTFBNCs0SHlFSXFqWG4xVHRVaC9ya0dJL3FuemhFNW1yOFdIcHJSSUpGZWdqczEwL0JiOE1kS3JoQ3VnVFpxClRTVHJmVStIRGt2WnNrZlppTjliYVF5aFk0dmJ4Q0R3N2ZiNkFSVnJlTmhoN25TZFhEMDZERTRqczRwcXBkbTUKUmx1S3FqOGhBb0dCQU84azduUEtaSCs5VXVBMkVka3V2NVUvbE00T2ZPSFB1aUxxZmNCVlhzc0lXMFFaZEx3agp5U04wOUJNeUllL0NtdmYzNlFFbU1XVER3MmdPREx4UmtJNHBOcE5mK1ZyTHQ4STRGNHZZMDJjOUY0U0JwdSs3CmpRdXRCdkdUVTdjbUFqR1F0MWYzZHpGZUdSV1FRSWgxa0MxcUFTeFE0eDFMMy9LSWx5ckNzMzJWQW9HQkFNVEkKL1o1cTVNY2h1S0d1dk92bVIvVXMxcXJ2eUtQSlc3Y0hoaHN6ODNvYWxlT2pyTFNmaFVGMVNRMmIzemNHM0RPSQo1aWdKN1NOeUthcUdnT292UFVkb2RoUk02dWwxUDlGcVJKVVlqalFsTmM3dnBacUNYVW44MVVwVmZCbTRSUkQ4CmZoZmhxencvVUFxTUxJWW11V0lEWUVRUGM1NExWY25TcmxPTGFEZzlBb0dCQU1jMHZHMDM2djk5ZGN2UFBvN3IKb2l0eEMwT2FUZXpNWFFFNDFBZWpGWk9MSW50WHVTWC9xVTBmM3pFZVVhYW5OTy9hVXYzaUVzTWRUMmtlU3YyVAo5Qlozdmo2RmMvRnVRV1JIMVZWcENMQzI4eUF0NENGUzJlc2Y5dWpGRUxjL3NoUVh1S0pPUWJ1ZDVzZFBvbklKCmZGQllQU0h0UDBMb01XU1c0MVY3V29rQkFvR0FjT05NZXdDZlZZMEd1ZG5nRHdQLzY2cFpTNTVhMzNxMzNudTIKZHd5S2RGV2ovdjc2S0hRS29jNkNwZ2Z4T1VQNk5xWW1Rbm5QVERKRnJNbVVVc1BleDRRcG1PTzNMMDVQMmZhNAplVCtvOUVrVVlTNGhOazNxN25MWWVOZ3BaU2ZNbHo0QnAvbVJuZkpFSElqbFVlQU5JU2tHcElTb3N0V1YxVDNECk83SVJpNUVDZ1lCNzJQUmJlajVCaUJHUDYwL1E0Ym92dEM0dlV3S0ttRXhQN2ZselQ1VnZLV2NsMU9lWmh6QjkKLzNtMWhRbkhNcnZyeEQ3REIxNlpNaDhsZzRiakhYQTY1UndQakFqR3dReHVVWjNReU5MZ3VsSDF1b3lqb3M4ZgpDVHpZZW5PdHNGTXZETW9NZVRXQUZ3V3dpbFBPSzd1RzFRSDR1VzRIVjkrRW5UMUhJV2tVd0E9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: default
type: Opaque
