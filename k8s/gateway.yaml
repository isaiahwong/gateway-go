##################################################
## Gateway Service
##################################################

apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: default
spec:
  ports:
    - name: http
      port: 5000
      targetPort: gateway-port
    - name: https
      port: 443
      targetPort: webhook-port
    # - name: admin
    #   port: 8080
    #   targetPort: admin-port
  selector:
    app: gateway
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-env-configmap
  namespace: default
data:
  APP_ENV: 'development'
  PORT: '5000'

  WEBHOOK_PORT: '8443'

  DISABLE_K8S_CLIENT: 'false'
  ENABLE_STACKDRIVER: 'false'

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - name: gateway
          image: registry.gitlab.com/isaiahwong/go/api/gateway
          imagePullPolicy: IfNotPresent
          ports:
            - name: gateway-port
              containerPort: 5000
            - name: webhook-port
              containerPort: 8443
            # - name: admin-port
            #   containerPort: 8080

          envFrom:
            - configMapRef:
                name: gateway-env-configmap

          volumeMounts:
            - name: webhook-tls-certs
              mountPath: /run/secrets/tls
              readOnly: true

          livenessProbe:
            httpGet:
              path: /hz
              port: 5000
            initialDelaySeconds: 60
            periodSeconds: 120

      volumes:
        - name: webhook-tls-certs
          secret:
            secretName: webhook-server-tls

      imagePullSecrets:
        - name: gitlab-auth

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: default
---
# Role
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: default
  name: api-gateway
rules:
  - apiGroups: ['', 'extensions', 'apps']
    resources: ['services', 'namespaces']
    verbs: ['get', 'list']

---
# Role Binding
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: default
  name: api-gateway-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-gateway
subjects:
  - kind: ServiceAccount
    name: api-gateway
    namespace: default

---
##################################################
## Gateway Webhook
##################################################

apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: gateway-webhook
  namespace: default
webhooks:
  - name: gateway-service.default.svc
    clientConfig:
      service:
        name: gateway-service
        namespace: default
        path: '/admission'
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRQ043cC9iV0xxTXFEQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd01qQTVNVEkxTlRVeVdoY05NekF3TWpBMk1USTFOVFV5V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRQzJFbFE3QlJDYm9HSFdWaW9XWm5EU25HcXU0Z2sxMFZLc3ZyeEdDalE0blVuVzlBTFUKbWpISVFWY0ZBZ01CdkFkTFkwb3pYSnoyaTAvbitUM0Izek1BU0V1TWNBeVVvMk10OE9pb0NBNy9UQnU5REtlTgpMZjN3TjE5K1JSY1o2dVE2S2RqM0w4Znp5K1dkQmNPR3Z6WVVrVmlqN0k5M2FXUVUxcWg4dmVNZFIzMlk3N2M0CnpHYTJYUUpDVVlLdXV4RHpzc2NhUDdzRkFjVmd1Z2dKYUlvY2c1Y2x0ajlTMlk1Rk5wUFZCNHhWZ0kyZHhkaHcKdUNkcEJaMWtrRjU3eWFKaWMzZXQxSFlibGlkNnZrQ3Rpb0RwTkdaU0hFbk04QTA1R0hwdjVwSnFGSXlRS1pYOAp3OUZqelpDc1hrbkRnVEozUzBZU3I3YmFoc1ZiOFA1TkRzZDNBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBSzhoSW5hTkYrSWpScE13L3luRE16WUpPaXZSTmc0b0p6aWoxMkgxcjRoaklUQ0RzNHFLOGxkSC9wOHEKMTVXbE5ZSEMvZlhoY3JqVW1NcXJrY1FmZjFXbmJNcWJha0JTN0gzejBOMWRXUUJSMEpoVVlNU2c5NkRZbEE2dwpkM09QaTdXd001b3dTbXFZS2wzNTZKbDdka2ZCQVRuNEJrcE0zdlVzeWhrQURPbjVKN3F6d2d5azhnZEdGQ0oyCjBLMnd5RWZVVE1hVllFcEhwNlhRYjNJejQ0S1c3Q29PZFJBelBXQklGOVIwZG1uVjk1R1BkenBYTmNwMkJ3Mm8KeCthaUhxZEs4dDlFb3NEVVhLV3NoSnpBYU5qczR5RW9EMHppcndCVWhRN0VZdDJoVGdVUXlBbnB1amVCM1ZoNQozK1JndHd3aFdKb1AzZ2UrS1o0dW84REJxejA9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ['*']
        apiGroups: ['*']
        apiVersions: ['*']
        resources: ['services']

---
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRQ043cC9iV0xxTXFEQU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd01qQTVNVEkxTlRVeVdoY05NekF3TWpBMk1USTFOVFV5V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRQzJFbFE3QlJDYm9HSFdWaW9XWm5EU25HcXU0Z2sxMFZLc3ZyeEdDalE0blVuVzlBTFUKbWpISVFWY0ZBZ01CdkFkTFkwb3pYSnoyaTAvbitUM0Izek1BU0V1TWNBeVVvMk10OE9pb0NBNy9UQnU5REtlTgpMZjN3TjE5K1JSY1o2dVE2S2RqM0w4Znp5K1dkQmNPR3Z6WVVrVmlqN0k5M2FXUVUxcWg4dmVNZFIzMlk3N2M0CnpHYTJYUUpDVVlLdXV4RHpzc2NhUDdzRkFjVmd1Z2dKYUlvY2c1Y2x0ajlTMlk1Rk5wUFZCNHhWZ0kyZHhkaHcKdUNkcEJaMWtrRjU3eWFKaWMzZXQxSFlibGlkNnZrQ3Rpb0RwTkdaU0hFbk04QTA1R0hwdjVwSnFGSXlRS1pYOAp3OUZqelpDc1hrbkRnVEozUzBZU3I3YmFoc1ZiOFA1TkRzZDNBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBSzhoSW5hTkYrSWpScE13L3luRE16WUpPaXZSTmc0b0p6aWoxMkgxcjRoaklUQ0RzNHFLOGxkSC9wOHEKMTVXbE5ZSEMvZlhoY3JqVW1NcXJrY1FmZjFXbmJNcWJha0JTN0gzejBOMWRXUUJSMEpoVVlNU2c5NkRZbEE2dwpkM09QaTdXd001b3dTbXFZS2wzNTZKbDdka2ZCQVRuNEJrcE0zdlVzeWhrQURPbjVKN3F6d2d5azhnZEdGQ0oyCjBLMnd5RWZVVE1hVllFcEhwNlhRYjNJejQ0S1c3Q29PZFJBelBXQklGOVIwZG1uVjk1R1BkenBYTmNwMkJ3Mm8KeCthaUhxZEs4dDlFb3NEVVhLV3NoSnpBYU5qczR5RW9EMHppcndCVWhRN0VZdDJoVGdVUXlBbnB1amVCM1ZoNQozK1JndHd3aFdKb1AzZ2UrS1o0dW84REJxejA9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRRDg0K0UrZFV1RCtqQU5CZ2txaGtpRzl3MEJBUVVGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd01qQTVNVEkxTlRVeVdoY05NakF3TXpFd01USTFOVFV5V2pBbQpNU1F3SWdZRFZRUUREQnRuWVhSbGQyRjVMWE5sY25acFkyVXVaR1ZtWVhWc2RDNXpkbU13Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUURUMGRFSlloa1QweGc1cWF5R3JRSXNlZmJKc3FqRWlYajYKb3FLSVo1YzRHNDdzWE1QWjdjZk40VlV2V0FWMGpvVGMwYm5JbmcwQzc0eThoY1Y1R1Y2S2J0SWErMDRoRSthWgpKK1o0b0UwUVAwVnp4Q1JXUmxMckdkVUJXN3ZOUXJLQm9JTzFsdGY0S0M3aGYxcjRQN201WUpUelJjYUJ4c3grClRuY25saC94ZHoxZGdrRDMzWlJjYVY0Z2tsVVZTMmcyaHF2SUVMWllvUlRVS2pKVHh6T2hoeS94YmpoVmJhV2MKZFErZk1mVnFZNUZpVmZ4Y0FWSUcyM0RTLzJ5RGtXend6YzdFN0FrT2R5UnMvM1E1MTVrVXR1ajhWcUVidUZEaApVc0J3UHRXam40UGp3L2FNeE14dTlvWmNoY0RMUDlmaEZUNjlmcnRMNFFlNzFQK2xVcDlYQWdNQkFBRXdEUVlKCktvWklodmNOQVFFRkJRQURnZ0VCQUlvTXJJNFE1RFFIQnptUnBhWUJjR0JKUTYvNG1CSHcyeE5ENmMxdklQR3MKdHBsODBEbFVreEpKdjZnQldsTkF6eXBQR0FxeFI2Zlh6YWdPVzM4ZUdnVExUY2FyTUNBRjRsMEEvbFNQcUJoYgpCa0dSQ1NkaktuTDFaT0Q5cWRiRDRKWkJIeXFqdzhyY2lvSWFyQkVUWitBOVI4bXBPS3BPY0dnVEpmR2F2UnBPCmZSN0Rsc2V4NHdPQUowNVFycUk4TEVvK3c2M3E3K29XSEN6V3JsME4xNnFZODlzeUNqaWxxYmljYnNPb0lUNjEKVmRwWFZ1bDljYUFFMUx6V0UyMStXNjUrVUZtY00wTUVsUlRjcms3cnVyZlllMXppQzVnNWdCT09wY2NDK0RtUQpjd1lSWmJkN0NCY2JOeHJIR2dDRGRnQ1VRd2s1SWZMaEJoTjc3OEVYbnJnPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBMDlIUkNXSVpFOU1ZT2Ftc2hxMENMSG4yeWJLb3hJbDQrcUtpaUdlWE9CdU83RnpECjJlM0h6ZUZWTDFnRmRJNkUzTkc1eUo0TkF1K012SVhGZVJsZWltN1NHdnRPSVJQbW1TZm1lS0JORUQ5RmM4UWsKVmtaUzZ4blZBVnU3elVLeWdhQ0R0WmJYK0NndTRYOWErRCs1dVdDVTgwWEdnY2JNZms1M0o1WWY4WGM5WFlKQQo5OTJVWEdsZUlKSlZGVXRvTm9hcnlCQzJXS0VVMUNveVU4Y3pvWWN2OFc0NFZXMmxuSFVQbnpIMWFtT1JZbFg4ClhBRlNCdHR3MHY5c2c1RnM4TTNPeE93SkRuY2tiUDkwT2RlWkZMYm8vRmFoRzdoUTRWTEFjRDdWbzUrRDQ4UDIKak1UTWJ2YUdYSVhBeXovWDRSVSt2WDY3UytFSHU5VC9wVktmVndJREFRQUJBb0lCQVFDd01IbHhGYUVJWlhGawpIV2Q5aXBFaFQ3M2duZlJWcm9mcjZyWEpRbWw5YVNia0luRmlaNi9uNTRQRTRyRis5MEU2c0ZTWnRDWGNpRWVIClZMb2lkZUMydzJHT3dmU0YvUmkxMG9PWldMVmhTMC9JOEtETkJxZllHTitkeHFFYkpseDNDSDRsNExmNkdlcU0KOVRORkJUVEdKcmtlOWE0ZHFxL1ViQTRlNW5maGo2cTdOQi80dHRvVFVBaFoxb3oxdGd4K0U5Ym1HTkFWeGJUVQorbUdtSldmWVNaa0FYMnhsNytjSU5wbC82YnpqZDkwcDgrQnl2aE9OTTlUTFNXVHBEWmJYeXU4K1VkZ0M4U21UClZ2VWVxZ09BNkRjZS8vUUhJa2Y5MlBhdjRhNUVQZFNPdkVwNW9YQTdCSWg5MUtid2owSDBQZWZTTkpxNHZVZ2wKV24vUG5PL0JBb0dCQVBONHNDM1JXMTNoeHh2RnlRWE4veWh4YjZZTkVseFQxVkNJR3BUcW1FNHJ6eFVtT1I5VgpBc1Bkb1JPWnRJeDFNZ3FJSG5obnBQRUFCWmx3QWVZS0EzYjVZeWgvVnBPUGo0NmxRaUM3dW5wZjRRUUpPU2ZICnlrS0pnVm9CZ2YvWTl0RnRJc2F4WU54RDlYWENta05VYlYzWGpwYVE2cUMzbmtJckRBT09pQnVoQW9HQkFONjQKSzZYZUdzV3VsaW5lb0R2TmJJVWFXTGlvYS9hTlVEa1JXOEFRMlVrMC8rOXVERis1UHd4ZDcwR1htRDFxRVREaQp6azVrYlVGcE8wSko3UnlFeVFzVUZtYWE3MzhMUUpWcWtOMmhpVGdsUzRYV2hsYWRHVXdoSDFSeFF5NW1Cbk9aCkx6aG5nU09yRS91d0RCL2pXNitOUzVrZlhjZUVZaG1qS2FkYk5KZjNBb0dBTEJ2RVJ6aXpoY21laWRDR1A2LzMKTnZ0K0Q2WTBtbGR4d05vM2ZwMFZwS3ZaSTJxK1ZJZlJMV3pjZnJHTS9SbEtUSkFtZlFmQjRRdHcrRUJMaDhKdQpxRUk4RFowc01TV0VDNEt5L1QwbFpvQXlRc25zK2VEL0twakF2MjZnZjVwdDlMa0I0TjlIdmYvdDJ6eTdOOUYyCjB0WjNkWjJoZENadjNHcnlEVDdvTjZFQ2dZRUF1MU5JVXdCV29FSlJ4dkdhNy9HOS9zM0VKYnh5NGpMRmNOcHEKdzBib215eGF2N1ZkN3YxT1RFYU53Q3VUUHNTQnBRNSsyMnlZZ0ZYVUk5TXQvYmlwcUFuRE5aWEhMcUgyTmpZbApsbVFSbUFtMlZlR3pxQklHZndPMDZEOURkRGtYNEE3TnFyRlQ2djR2bHBmaCtzZ3VDNS9hSC9aRDJGWStkTFhKCmlSdXJSczBDZ1lCSWxpVzloaHJSZlovemFQajcxdTVvZnlNRXBPdWVCb1RSTjZuVEh1amV2RzZ1eC9md3VpNGIKWDVHb3EwdC83U1NnVWNZN3VHbFpYWkFrOUpEc2JBMXlTcTZJOVIyOVFFWWgwZ25Zc29vcTd1TG55dXltZ2h1WQpmeGMxRkxrdURJalVJNlljTnRrYk94ZlFlVE0yTS9nT25yMTdmeXNISHRnc1dNSW9OeE1OdFE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: default
type: Opaque
