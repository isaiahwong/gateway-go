##################################################
## Gateway Service
##################################################

apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: default
spec:
  ports:
    - name: http
      port: 5000
      targetPort: gateway-port
    - name: https
      port: 443
      targetPort: webhook-port
    # - name: admin
    #   port: 8080
    #   targetPort: admin-port
  selector:
    app: gateway
  type: ClusterIP

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-env-configmap
  namespace: default
data:
  APP_ENV: 'development'
  PORT: '5000'

  WEBHOOK_PORT: '8443'

  DISABLE_K8S_CLIENT: 'false'
  ENABLE_STACKDRIVER: 'false'

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - name: gateway
          image: registry.gitlab.com/isaiahwong/cluster/gateway
          imagePullPolicy: IfNotPresent
          ports:
            - name: gateway-port
              containerPort: 5000
            - name: webhook-port
              containerPort: 8443
            # - name: admin-port
            #   containerPort: 8080

          envFrom:
            - configMapRef:
                name: gateway-env-configmap

          volumeMounts:
            - name: webhook-tls-certs
              mountPath: /run/secrets/tls
              readOnly: true

          livenessProbe:
            httpGet:
              path: /hz
              port: 5000
            initialDelaySeconds: 60
            periodSeconds: 120

      volumes:
        - name: webhook-tls-certs
          secret:
            secretName: webhook-server-tls

      imagePullSecrets:
        - name: gitlab-auth

---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: default
---
# Role
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: default
  name: api-gateway
rules:
  - apiGroups: ['', 'extensions', 'apps']
    resources: ['services', 'namespaces']
    verbs: ['get', 'list']

---
# Role Binding
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: default
  name: api-gateway-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: api-gateway
subjects:
  - kind: ServiceAccount
    name: api-gateway
    namespace: default

---
##################################################
## Gateway Webhook
##################################################

apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: gateway-webhook
  namespace: default
webhooks:
  - name: gateway-service.default.svc
    clientConfig:
      service:
        name: gateway-service
        namespace: default
        path: '/admission'
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRREhYZkpER3RKeDF6QU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd01qRXdNVE15TXpReldoY05NekF3TWpBM01UTXlNelF6V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRQytzTGdDemIzT1h0YjBhWlpISnJFaTQyS2xPeEFSa0Y0NGU3WGxzWUh5bkcxYWR5Y3IKREJ6Y1J3dFBNeUdGWmlvN0VVOGtpQzQ0L0t6UERTemNiT1BwMzBDREIwczFYTTlvZmRJWXduSmMwL3ozYmtzcApxYjVmZ21icitBeGlIbzRtZXM4djV4NVlmRVY4S2ZNcXFLTkVwUWdLRjJQYXYrNGlmb3MvUlJ3WWFOUUZkWWIyCnQyQ25uK3hveUN0YzNySGdnckJnSGlLUUVIRGIwbHpFMFBIZjM5Wmd2MjNaaFNNaldweUNENndJUHVENnlXcTEKZmZXRkdaMVA4TlBLRmpBRGtuZ01neTlVNE11bzBQbFJrQW5XaE9OeU9uMjlGNUg3L1QxeHhyMnRJU24zOEJNYgpzM1oyTExHOGQzdm9JT2JRcTZVUXR5aG5CenRxZU1ZZ2xQRlZBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBQUdCejNwZ2JRV0FqemJHNDNrdURMNVVTaVpVODA2SmVTQUNIWjdZZ211V3NTVXBtOHRMRms5cW0wd2sKUy9GWjlUNCt6bWpIa00rWFJad1ZXOXZ3VlY4OXBUVEZUTVgvemc4SmJ5U3pnelBGQ21UUWV1WTdCcjZaVzZOMgpIMWpXRXA5eEFWaitKbmgrUjFpZVJjRlZ0T3d0NzlyR2NuTHNLTm15MGVSeHNsM05ENWxmMU4wcGxJQStqUUlQCkN6K1VSMUEzMWxrYVRvaDJBMklUV1h1eDQrZ0JrNkZMMmRZMWxBNEtPWEVnby9Pb1NTM051eXY4TU11YTZYRG8KeTZsbElQdC9ZN1EzKzlUbUJUZk9JNzlHK29QTWNyZk1PcjREbGVWdDFUS2JFVVE2UTZGdDAzTkxaWjEzdmtxdwpINGlaQmpzMEk0a2ZTZ29FKzE4R3Rvd2VoSFk9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ['*']
        apiGroups: ['*']
        apiVersions: ['*']
        resources: ['services']

---
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNzRENDQVpnQ0NRREhYZkpER3RKeDF6QU5CZ2txaGtpRzl3MEJBUXNGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd01qRXdNVE15TXpReldoY05NekF3TWpBM01UTXlNelF6V2pBYQpNUmd3RmdZRFZRUUtEQTluWVhSbGQyRjVMWE5sY25acFkyVXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRQytzTGdDemIzT1h0YjBhWlpISnJFaTQyS2xPeEFSa0Y0NGU3WGxzWUh5bkcxYWR5Y3IKREJ6Y1J3dFBNeUdGWmlvN0VVOGtpQzQ0L0t6UERTemNiT1BwMzBDREIwczFYTTlvZmRJWXduSmMwL3ozYmtzcApxYjVmZ21icitBeGlIbzRtZXM4djV4NVlmRVY4S2ZNcXFLTkVwUWdLRjJQYXYrNGlmb3MvUlJ3WWFOUUZkWWIyCnQyQ25uK3hveUN0YzNySGdnckJnSGlLUUVIRGIwbHpFMFBIZjM5Wmd2MjNaaFNNaldweUNENndJUHVENnlXcTEKZmZXRkdaMVA4TlBLRmpBRGtuZ01neTlVNE11bzBQbFJrQW5XaE9OeU9uMjlGNUg3L1QxeHhyMnRJU24zOEJNYgpzM1oyTExHOGQzdm9JT2JRcTZVUXR5aG5CenRxZU1ZZ2xQRlZBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFECmdnRUJBQUdCejNwZ2JRV0FqemJHNDNrdURMNVVTaVpVODA2SmVTQUNIWjdZZ211V3NTVXBtOHRMRms5cW0wd2sKUy9GWjlUNCt6bWpIa00rWFJad1ZXOXZ3VlY4OXBUVEZUTVgvemc4SmJ5U3pnelBGQ21UUWV1WTdCcjZaVzZOMgpIMWpXRXA5eEFWaitKbmgrUjFpZVJjRlZ0T3d0NzlyR2NuTHNLTm15MGVSeHNsM05ENWxmMU4wcGxJQStqUUlQCkN6K1VSMUEzMWxrYVRvaDJBMklUV1h1eDQrZ0JrNkZMMmRZMWxBNEtPWEVnby9Pb1NTM051eXY4TU11YTZYRG8KeTZsbElQdC9ZN1EzKzlUbUJUZk9JNzlHK29QTWNyZk1PcjREbGVWdDFUS2JFVVE2UTZGdDAzTkxaWjEzdmtxdwpINGlaQmpzMEk0a2ZTZ29FKzE4R3Rvd2VoSFk9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRRG5OQ0k3ZmxvRmV6QU5CZ2txaGtpRzl3MEJBUVVGQURBYU1SZ3dGZ1lEVlFRS0RBOW4KWVhSbGQyRjVMWE5sY25acFkyVXdIaGNOTWpBd01qRXdNVE15TXpRMFdoY05NakF3TXpFeE1UTXlNelEwV2pBbQpNU1F3SWdZRFZRUUREQnRuWVhSbGQyRjVMWE5sY25acFkyVXVaR1ZtWVhWc2RDNXpkbU13Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUURmUUIyelVTcU9RalR1VCtWTHYrKzdyZEo3cmd2aVh2WjMKTWhBUkdhRVhtL3A2WEV3SEN0ODJWSS83c0x2MmZGMjNCYndBTUgyckZaamFpQ1pQV094VGhUakxhQy9Gckw1cApDYWpNSlc2RGNYOGh3QUk3S0k0R1kxRk84N3dtU1FXVTVDeElBTFJuVGpSbXBCdEdGL0tLNnZjWTVrRE5LQzhXClUyK2NOaDRBR1dxVit3OUhJOFd4V3BiUmJUZnE5aDVqNFR4UnUyRFN2c21Od1l4VDBpclkvL3RadjZjQVRoZkEKemMyL05iNFRIN0VidVZFZnB1UTFUbEFRTlJBWVZCN2dTOXFYOEdjc0F2b05vODFhYUlXOWVVbWxzblBUQlZyNworVzJuMzFUK2JrN2QrWVFoRGVJbGVnR0xOUFl0YlJRNW84Vk0zRmY5bHdGRmIwK2JPRFYzQWdNQkFBRXdEUVlKCktvWklodmNOQVFFRkJRQURnZ0VCQUZ4RGhUVmtOdCs4WkdnRHVBckwzQkZCTUJqRFRKNWFpeVptcTRxL3pqREwKTis3ZzhJOGFaYWpodENjV2JyeE10VCtsUjY2enJPUGI5amlibUVHbGlHMmJPdHl2Mnp2VUJGdWJwaXRTUFFUMApLYWVVN1pDSFFSd2ttbjYyWjJPaWl0LzlDVDdsajBhcDlVeDdaaDNYUFFLcklZNFNiVjc1d1RPelRGdHN0SC9wCjdKWkU2SFJWdlFQK3RiYUlMTXZaczh3dW9sdU04VERranJrcEYzcVcxRE95Y0JMTzZyVVFYWlJsdHI5ZjA1dFoKd0FuUUw0VmNQc25Ha3NCbkNudTRKR0w5WG16WUxxZTRETW1MUFZrUTRVUTdqNm0rdjlxeHZ2cXRXL3k2azFmNQpwV1RqMS9Lbm52am1abXgzR2tOSXEvWWl1R2J6WWI2UW9MUExnK3pKQ3JBPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBMzBBZHMxRXFqa0kwN2svbFM3L3Z1NjNTZTY0TDRsNzJkeklRRVJtaEY1djZlbHhNCkJ3cmZObFNQKzdDNzlueGR0d1c4QURCOXF4V1kyb2dtVDFqc1U0VTR5Mmd2eGF5K2FRbW96Q1Z1ZzNGL0ljQUMKT3lpT0JtTlJUdk84SmtrRmxPUXNTQUMwWjA0MFpxUWJSaGZ5aXVyM0dPWkF6U2d2RmxOdm5EWWVBQmxxbGZzUApSeVBGc1ZxVzBXMDM2dlllWStFOFVidGcwcjdKamNHTVU5SXEyUC83V2IrbkFFNFh3TTNOdnpXK0V4K3hHN2xSCkg2YmtOVTVRRURVUUdGUWU0RXZhbC9CbkxBTDZEYVBOV21pRnZYbEpwYkp6MHdWYSsvbHRwOTlVL201TzNmbUUKSVEzaUpYb0JpelQyTFcwVU9hUEZUTnhYL1pjQlJXOVBtemcxZHdJREFRQUJBb0lCQUFXVWJxbWFyN3VhZ0FRcwp6d2hUcGNSRkZldXRiL0thZVFLRnA4MGxuTmNnT09SeUJoeHU4eUZDZjg3RW5nNE5FYktQWENHTkZMYi85VEFSCkV4UU1udXQvZXVucWtyY1lHREk3NFpJb3BWaDNyN3ZDTnN3UHVXMERjbmJNdExrb1BoRjRtbnE2T2NnVE5sQVMKYmZRVWlTVmJ0ZzFUUSs5Y3Y4Q0pHVk1JTHp2Rld1Y2RoSlpSRFYrOVdiZ0pLakd6OG9XcDc4VTIxVmtVWjgySApKQ3doc1VYeXMwUldhbTlwSHJmTXVNWXR5L0J4Zy9YY2JkMWNzZTFzQTVDWEExTHgraHZ2SkY0MDlGNlo1RDFsCjJtSjV1bHhoK3JKZzBuNnNIOGRoc1F4OUVEN3lyNWhkNXMyVjlEUEpvNjhDMERLVEFMSGNsV3hwNWhkTkpLSDEKaEl1ZkJuRUNnWUVBOGY0QXhzOWhRYmFjMHhwUXdUWlpQcXF0c3E1aEZmOUZXVHNpU2plVzZRUkkzZmpOYVVTdgpOa1BiNFY5ZVBpNGhHc0V6Q3JYSEhVMEhEU3BKYndrdjdQVThPdVpxc2RRbzNMaU15RlI5TERnN2FwVXhIYzVJCllFYzFJMGZEdHVwOGhPZktFSXk3bThEUzZTamRVT05Ja29XTjY1YXhabTVlNFFMVnZZTWhMZXNDZ1lFQTdDeGkKdXVXSHpLK2NGMFRoK2RvWmpvT3QxK28ya2h0bnkrc0RCRlYwUFRMT0RqWjhSM01zSlN4alRJSFN5dUFVRjR1Sgp3Wm5zWkIxczdjaHlyUEdPVG1CazZQQWt1RG5OeXV4Y3doU1h3dGRsWmxxcE5aYnRXNjZaRm5Xb2VZRXpXRlQ1CmdXbXhWTS9rSVZqakxhc3FqMUpjbXJwV1VCVWZJVmFVelo1QWw2VUNnWUErc2JMYnp4Q0FhT0k2WXYvMi9yQ2kKWnErM3NpdmUraEtxYW9LWXZjd3dOSGI0WXlROG1KbllNajUrSmlvUmEvd1JwV29tNVM5ZjdQdmRzazN5SVd3MApOTmpVM2F0WXhRR05KWmI3czcvMk85OVEzclFwNTY2aW12QXVZc0pXMm10R041TUhOSjdLWEd1SUVwazhBcFpqCnQ0d3NOQTlqM1VaaGYwMkcycmsyM3dLQmdBZTd4RmZlWUQ0Qm1oamc5bzFaNlBCVHU0T1FkY3orL0wwZXF2Q2YKWTdrRlN0NElScldJUGUvUnJrYTVFWS8zR25GUzdtWGFoblVZeVpKWHQvbVZ4MVVscnVnNXhOb0xlb09ramIwRgpNNXI3dHFSTlg3RVRpaDR3YjI3ZTEyOXpIWjFNMndhejBVeTNxZjYxakdyWWFnSmJiaERhL1N5T0pJRFE5dnBzCnJpekpBb0dCQU9ncnA4T3RJUzRjN2JhV1VIeUNIN3lIVUw1S1dMS0xlQ0RDWVc5WVRrUzZIbWI4dkFUdDI2NVcKTEtjYThMNkVIejZVL21hcklmcGJvendiZTZLRHVrZHkybXRPZTVUOFFCSDZnSkh6SlBhNXJkWUNKOFVLUTBHQQpTaXhBeExvWm50L2U5Z3NPbG9QcTd2RkhWZmlSOFhndlJjTmViKytpWXowcVF5YUUzT1lBCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: default
type: Opaque
